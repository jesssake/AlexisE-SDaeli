import { Component, ElementRef, OnInit } from '@angular/core';
import { FormsModule } from '@angular/forms';
import { CommonModule } from '@angular/common';
import { Router, RouterLink } from '@angular/router';

@Component({
  selector: 'app-login',
  standalone: true,
  imports: [CommonModule, FormsModule, RouterLink],
  templateUrl: './login.component.html',
  styleUrls: ['./login.component.scss'],
})
export class LoginComponent implements OnInit {
  // modelo del formulario
  model = {
    email: '',
    password: '',
    userType: 'Cliente' as 'Cliente' | 'Administrador',
  };

  // estados UI
  loading = false;
  showPass = false;

  // recuperaciÃ³n/reset
  recoveryOpen = false;
  resetOpen = false;
  showNew = false;
  showConfirm = false;
  modalState: 'entering' | 'leaving' | 'static' = 'static';

  recovery = {
    email: '',
    answers: ['', '', '', '', ''] as string[],
  };

  reset = {
    newPassword: '',
    confirmPassword: '',
  };

  // estados del monito
  showMonkey = false;
  isPeeking = false;
  isHiding = false;
  isHappy = false;
  isSurprised = false;
  isCovering = false;
  showSpeech = false;
  monkeyMessage = '';

  // control de validaciones recientes
  private lastValidationState = {
    minLength: false,
    lowercase: false,
    uppercase: false,
    number: false
  };

  // mensajes de error
  errors: Record<string, string> = {};

  // preguntas
  recoveryQuestions = [
    'Â¿CuÃ¡l es el nombre de tu primera mascota?',
    'Â¿En quÃ© ciudad naciste?',
    'Â¿CuÃ¡l es tu comida favorita?',
    'Â¿CuÃ¡l fue tu primer colegio?',
    'Â¿CuÃ¡l es el nombre de tu mejor amigo de la infancia?',
  ];

  constructor(
    private host: ElementRef<HTMLElement>,
    private router: Router
  ) {}

  ngOnInit(): void {
    // Mostrar monito despuÃ©s de un tiempo
    setTimeout(() => {
      this.showMonkey = true;
      this.isPeeking = true;
      this.showMonkeyMessage('Â¡Hola! Soy tu amigo mono ðŸµ');
    }, 2000);

    // Enfocar el email al cargar
    setTimeout(() => {
      const el = this.host.nativeElement.querySelector<HTMLInputElement>('#email');
      el?.focus();
    });
  }

  // MÃ©todos del monito
  onEmailFocus() {
    this.isSurprised = true;
    this.showMonkeyMessage('Â¿Tu correo? Â¡QuÃ© emocionante! ðŸ“§');
  }

  onEmailBlur() {
    this.isSurprised = false;
    this.hideMonkeyMessage();
  }

  onPasswordFocus() {
    this.isCovering = true;
    this.showMonkeyMessage('Â¡Shhh! No miro, prometo ðŸ¤«');
  }

  onPasswordBlur() {
    this.isCovering = false;
    this.hideMonkeyMessage();
  }

  onPasswordInput() {
    if (this.model.password.length > 0) {
      this.isHappy = true;
      setTimeout(() => {
        this.isHappy = false;
      }, 1000);
    }
  }

  onNewPasswordInput() {
    this.checkPasswordChanges();
  }

  onConfirmPasswordInput() {
    if (this.reset.newPassword === this.reset.confirmPassword && this.reset.confirmPassword.length > 0) {
      this.showMonkeyMessage('Â¡Perfecto! Las contraseÃ±as coinciden ðŸŽ‰');
    }
  }

  private checkPasswordChanges() {
    const currentState = {
      minLength: this.hasMinLength,
      lowercase: this.hasLowercase,
      uppercase: this.hasUppercase,
      number: this.hasNumber
    };

    // Verificar cambios y mostrar mensajes
    if (currentState.minLength && !this.lastValidationState.minLength) {
      this.showMonkeyMessage('Â¡Bien! Ya tienes 8 caracteres ðŸ“');
    }
    if (currentState.lowercase && !this.lastValidationState.lowercase) {
      this.showMonkeyMessage('Â¡Excelente! Letras minÃºsculas incluidas ðŸ”¤');
    }
    if (currentState.uppercase && !this.lastValidationState.uppercase) {
      this.showMonkeyMessage('Â¡Genial! MayÃºsculas tambiÃ©n ðŸ…°ï¸');
    }
    if (currentState.number && !this.lastValidationState.number) {
      this.showMonkeyMessage('Â¡Perfecto! NÃºmeros incluidos ðŸ”¢');
    }

    this.lastValidationState = { ...currentState };
  }

  showMonkeyMessage(message: string) {
    this.monkeyMessage = message;
    this.showSpeech = true;
    
    setTimeout(() => {
      this.hideMonkeyMessage();
    }, 3000);
  }

  hideMonkeyMessage() {
    this.showSpeech = false;
  }

  togglePasswordVisibility() {
    this.showPass = !this.showPass;
    if (this.showPass) {
      this.showMonkeyMessage('Â¡Cuidado! Alguien podrÃ­a estar mirando ðŸ‘€');
      this.isSurprised = true;
      setTimeout(() => this.isSurprised = false, 2000);
    }
  }

  toggleNewPasswordVisibility() {
    this.showNew = !this.showNew;
  }

  toggleConfirmPasswordVisibility() {
    this.showConfirm = !this.showConfirm;
  }

  // Animaciones para elementos
  shakeElement(elementId: string) {
    const element = document.getElementById(elementId);
    if (element) {
      element.classList.add('shake');
      setTimeout(() => {
        element.classList.remove('shake');
      }, 500);
    }
  }

  justBecameValid(type: keyof typeof this.lastValidationState): boolean {
    const current = this[`has${type.charAt(0).toUpperCase() + type.slice(1)}` as keyof this] as boolean;
    const last = this.lastValidationState[type];
    return current && !last;
  }

  // Getters para validaciÃ³n visual de contraseÃ±a
  get hasMinLength(): boolean {
    return this.reset.newPassword.length >= 8;
  }

  get hasLowercase(): boolean {
    return /[a-z]/.test(this.reset.newPassword);
  }

  get hasUppercase(): boolean {
    return /[A-Z]/.test(this.reset.newPassword);
  }

  get hasNumber(): boolean {
    return /\d/.test(this.reset.newPassword);
  }

  // helpers
  private emailOk(v: string) { return /^[\w.%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/.test(v); }
  private passOk(v: string)  { return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/.test(v); }

  private showAlert(message: string, type: 'info'|'success'|'error'='info') {
    const container = document.getElementById('alert-container')!;
    const div = document.createElement('div');
    div.className = `alert alert-${type}`;
    div.textContent = message;
    container.appendChild(div);
    setTimeout(() => div.remove(), 3500);
    if (type === 'success') this.startConfetti();
  }

  private startConfetti() {
    const canvas = document.getElementById('confetti-canvas') as HTMLCanvasElement | null;
    if (!canvas) return;
    const ctx = canvas.getContext('2d')!;
    const W = (canvas.width = window.innerWidth);
    const H = (canvas.height = window.innerHeight);
    const parts = Array.from({ length: 100 }).map(() => ({
      x: Math.random() * W, y: -10, s: 3 + Math.random() * 5,
      vx: -2 + Math.random() * 4, vy: 1 + Math.random() * 3,
      a: Math.random() * Math.PI,
    }));
    let t = 0;
    const loop = () => {
      if (t++ > 120) return;
      ctx.clearRect(0, 0, W, H);
      parts.forEach(p => {
        p.x += p.vx; p.y += p.vy; p.a += 0.1;
        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.a);
        ctx.fillStyle = ['#FFD700','#E76F51','#4A90E2','#2A9D8F'][Math.floor(Math.random()*4)];
        ctx.fillRect(-p.s/2, -p.s/2, p.s, p.s);
        ctx.restore();
      });
      requestAnimationFrame(loop);
    };
    loop();
  }

  /* ====== LOGIN ====== */
  async submit() {
    this.errors = {};
    if (!this.model.email) this.errors['email'] = 'Ingresa tu correo';
    else if (!this.emailOk(this.model.email)) this.errors['email'] = 'Correo no vÃ¡lido';
    if (!this.model.password) this.errors['password'] = 'Ingresa tu contraseÃ±a';
    if (Object.keys(this.errors).length) return;

    this.loading = true;
    this.showMonkeyMessage('Â¡Verificando tus datos! â³');
    
    try {
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tutorEmail: this.model.email,
          tutorPassword: this.model.password,
          userType: this.model.userType,
        }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Error al iniciar sesiÃ³n');

      sessionStorage.setItem('token', data.token);
      sessionStorage.setItem('loginData', JSON.stringify({ 
        email: this.model.email, 
        userType: this.model.userType 
      }));
      
      this.showMonkeyMessage('Â¡Ã‰xito! Redirigiendo... ðŸŽ‰');
      this.showAlert('Inicio de sesiÃ³n exitoso. Redirigiendo...', 'success');
      
      // âœ… CORREGIDO: Usar Router para navegaciÃ³n
      setTimeout(() => {
        if (this.model.userType === 'Administrador') {
          // Redirigir al menÃº del maestro usando Router
          this.router.navigate(['/maestro']);
        } else {
          // Para cliente, redirigir al menÃº del alumno
          this.router.navigate(['/alumno']);
        }
      }, 800);
      
    } catch (e: any) {
      this.showMonkeyMessage('Â¡Ups! Algo saliÃ³ mal ðŸ˜¢');
      this.showAlert(e.message || 'Error al iniciar sesiÃ³n', 'error');
    } finally {
      this.loading = false;
    }
  }

  /* ====== RECOVERY ====== */
  openRecovery(ev: Event) {
    ev.preventDefault();
    this.modalState = 'entering';
    this.recoveryOpen = true;
    this.resetOpen = false;
    this.errors = {};
    if (!this.recovery.email) this.recovery.email = this.model.email || '';
    
    setTimeout(() => {
      this.modalState = 'static';
    }, 600);
    
    // Enfocar el primer campo del modal
    setTimeout(() => {
      const emailInput = document.getElementById('recovery-email') as HTMLInputElement;
      emailInput?.focus();
    }, 100);
  }

  closeRecovery() {
    this.modalState = 'leaving';
    setTimeout(() => {
      this.recoveryOpen = false;
      this.modalState = 'static';
    }, 400);
    this.errors = {};
  }

  async submitRecovery() {
    this.errors = {};
    if (!this.recovery.email) this.errors['recoveryEmail'] = 'Ingresa tu correo';
    else if (!this.emailOk(this.recovery.email)) this.errors['recoveryEmail'] = 'Correo no vÃ¡lido';
    this.recovery.answers.forEach((v, i) => { if (!v) this.errors['rq'+i] = 'Ingresa tu respuesta'; });
    if (Object.keys(this.errors).length) return;

    this.loading = true;
    this.showMonkeyMessage('Verificando tus respuestas... ðŸ”');
    
    try {
      const res = await fetch('/api/recover', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tutorEmail: this.recovery.email, answers: {
          q1: this.recovery.answers[0], q2: this.recovery.answers[1], q3: this.recovery.answers[2],
          q4: this.recovery.answers[3], q5: this.recovery.answers[4],
        }}),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Error al verificar respuestas');

      this.showMonkeyMessage('Â¡Respuestas correctas! ðŸŽ‰');
      this.showAlert('Respuestas verificadas', 'success');
      this.closeRecovery();
      this.resetOpen = true;
      setTimeout(() => {
        const np = document.getElementById('new-password') as HTMLInputElement | null;
        np?.focus();
      });
    } catch (e: any) {
      this.showMonkeyMessage('Â¡Algunas respuestas no son correctas! ðŸ˜…');
      this.showAlert(e.message || 'Error en recuperaciÃ³n', 'error');
    } finally {
      this.loading = false;
    }
  }

  closeReset() {
    this.modalState = 'leaving';
    setTimeout(() => {
      this.resetOpen = false;
      this.modalState = 'static';
    }, 400);
    this.errors = {};
    this.reset = { newPassword: '', confirmPassword: '' };
  }

  async submitReset() {
    this.errors = {};
    if (!this.passOk(this.reset.newPassword)) this.errors['newPassword'] = 'MÃ­n. 8, mayÃºscula, minÃºscula y nÃºmero';
    if (this.reset.newPassword !== this.reset.confirmPassword) this.errors['confirmPassword'] = 'Las contraseÃ±as no coinciden';
    if (Object.keys(this.errors).length) return;

    this.loading = true;
    this.showMonkeyMessage('Actualizando tu contraseÃ±a... ðŸ”„');
    
    try {
      const res = await fetch('/api/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tutorEmail: this.recovery.email, newPassword: this.reset.newPassword }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Error al restablecer contraseÃ±a');

      this.showMonkeyMessage('Â¡ContraseÃ±a actualizada! ðŸŽŠ');
      this.showAlert('ContraseÃ±a actualizada', 'success');
      this.closeReset();
    } catch (e: any) {
      this.showMonkeyMessage('Â¡Ups! No se pudo actualizar ðŸ˜…');
      this.showAlert(e.message || 'Error al restablecer', 'error');
    } finally {
      this.loading = false;
    }
  }
}
