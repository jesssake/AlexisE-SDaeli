<div class="calificaciones-wrapper">
  <!-- Toolbar -->
  <div class="toolbar-card">
    <div class="left">
      <label class="label-tri">
        Trimestre:
        <select
          class="select-tri"
          [ngModel]="trimestreSeleccionado()"
          (ngModelChange)="onTrimestreChange($event)"
          [disabled]="cargando || guardando"
        >
          <option *ngFor="let tri of trimestres()" [value]="tri.id">
            {{ tri.nombre }} <span *ngIf="tri.activo === 1">(activo)</span>
          </option>
        </select>
      </label>

      <button
        class="btn-recargar"
        (click)="cargarCalificaciones(trimestreSeleccionado()!)"
        [disabled]="cargando || guardando || !trimestreSeleccionado()"
      >
        游댃 Recargar
      </button>
    </div>

    <div class="right">
      <button
        class="btn-guardar"
        (click)="guardarCambios()"
        [disabled]="guardando || cargando || !trimestreSeleccionado()"
      >
        游 Guardar porcentajes
      </button>
    </div>
  </div>

  <!-- Alertas -->
  <div *ngIf="cargando" class="alert info">Cargando informaci칩n...</div>
  <div *ngIf="errorMsg" class="alert error">{{ errorMsg }}</div>
  <div *ngIf="successMsg" class="alert success">{{ successMsg }}</div>

  <!-- Lista de alumnos -->
  <ng-container *ngFor="let grupo of gruposAlumnos()">
    <div class="alumno-card">
      <div class="alumno-header">
        <div class="alumno-nombre"><strong>{{ grupo.alumno_nombre }}</strong></div>
        <div class="alumno-promedio">
          Promedio trimestre:
          <span class="promedio-num">{{ grupo.promedioTrimestre | number: '1.2-2' }}</span>
        </div>
      </div>

      <div class="alumno-body">
        <table class="tabla-tareas">
          <thead>
            <tr>
              <th>Tarea</th>
              <th>Calificaci칩n</th>
              <th>% del trimestre</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let tarea of grupo.tareas">
              <td class="tarea-nombre">{{ tarea.titulo_tarea }}</td>
              <td class="tarea-calif"><span class="badge-nota">{{ tarea.calificacion }}</span></td>
              <td class="tarea-porc">
                <input
                  type="number"
                  class="input-porcentaje"
                  min="0" max="100" step="0.5"
                  [disabled]="guardando || cargando"
                  [ngModel]="tarea.porcentaje"
                  (ngModelChange)="actualizarPorcentaje(grupo.alumno_id, tarea.tarea_id, $event)"
                />
              </td>
            </tr>
          </tbody>
        </table>

        <div class="nota-ayuda">
          * Promedio ponderado = (풖 calificaci칩n칑%) / (풖 %).<br />
          * Si todos los % est치n en 0, se usa el promedio simple.
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Vac칤o -->
  <div *ngIf="!cargando && !errorMsg && gruposAlumnos().length === 0" class="alert info">
    No hay calificaciones registradas para este trimestre.
  </div>
</div>
