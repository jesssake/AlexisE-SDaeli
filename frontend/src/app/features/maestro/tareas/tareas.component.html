<div class="page-wrap">
  
  <!-- TÃ­tulo principal -->
  <h1 class="page-title">
    GestiÃ³n de Tareas <span>Panel del Maestro</span>
  </h1>

  <!-- Filtros por trimestre -->
  <div class="trimestre-filtros">
    <button class="chip"
            [class.activo]="trimestreSeleccionado === 'all'"
            (click)="setTrimestre('all')">
      <span class="emoji">ğŸ“Š</span> Todas las Tareas
    </button>

    <button class="chip"
            [class.activo]="trimestreSeleccionado === '1'"
            (click)="setTrimestre('1')">
      <span class="emoji">1ï¸âƒ£</span> 1Â° Trimestre
    </button>

    <button class="chip"
            [class.activo]="trimestreSeleccionado === '2'"
            (click)="setTrimestre('2')">
      <span class="emoji">2ï¸âƒ£</span> 2Â° Trimestre
    </button>

    <button class="chip"
            [class.activo]="trimestreSeleccionado === '3'"
            (click)="setTrimestre('3')">
      <span class="emoji">3ï¸âƒ£</span> 3Â° Trimestre
    </button>
  </div>

  <!-- Panel de depuraciÃ³n -->
  <div class="debug-panel" *ngIf="tareas.length > 0">
    <div class="debug-title">InformaciÃ³n</div>
    <div class="debug-content">
      <strong>Tareas cargadas:</strong> {{ tareas.length }}<br>
      <strong>Materias cargadas:</strong> {{ materias.length }}<br>
      <strong>Tarea seleccionada:</strong> {{ tareaSeleccionada?.titulo || 'Ninguna' }}<br>
      <strong> Materia seleccionada:</strong> {{ tareaSeleccionada?.id_materia || 'null' }}<br>
      <strong>Â¿Editando tarea?:</strong> {{ editandoTarea ? 'SÃ­' : 'No' }}<br>
      <strong> Tarea actual:</strong> {{ formTarea.id_tarea || 'Ninguna' }}
    </div>
  </div>

  <!-- Mensaje de carga -->
  <div *ngIf="loadingTareas" class="loading-message">
    <div class="spinner"></div>
    <p>Cargando tareas...</p>
  </div>

  <!-- Mensaje de error -->
  <div *ngIf="errorTareas && !loadingTareas" class="error-message">
    <span class="emoji">âš ï¸</span> {{ errorTareas }}
    <button class="btn btn-neutral" (click)="cargarTareas()">Reintentar</button>
  </div>

  <!-- Lista de tareas -->
  <section class="card" *ngIf="!loadingTareas && !errorTareas">
    <div class="card-header">
      <div>
        <h2 class="card-title">
          <span class="emoji">ğŸ“‹</span> Mis Tareas Publicadas
        </h2>
        <p class="card-desc">
          Administra todas tus tareas acadÃ©micas. 
          <strong>{{ tareasFiltradas.length }}</strong> tareas encontradas
          <span *ngIf="loadingTareas" class="loading-text"> (cargando...)</span>
        </p>
      </div>

      <div class="actions-right">
        <button class="btn btn-primary" 
                (click)="abrirModalNuevaTarea()">
          <span class="emoji">â•</span> Nueva Tarea
        </button>

        <button class="btn btn-warning"
                (click)="abrirModalMaterias()">
          <span class="emoji">ğŸ“</span> Gestionar Materias
        </button>
      </div>
    </div>

    <!-- Tabla de tareas -->
    <table class="tabla" *ngIf="tareasFiltradas.length > 0">
      <thead>
        <tr>
          <th width="150">Materia</th>
          <th>TÃ­tulo y DescripciÃ³n</th>
          <th width="180">Fecha LÃ­mite</th>
          <th width="120">Entrega Tarde</th>
          <th width="100">Estado</th>
          <th width="120">Entregas</th>
          <th width="180">Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let t of tareasFiltradas"
            [class.row-activa]="tareaSeleccionada?.id_tarea === t.id_tarea"
            (click)="seleccionarTarea(t)"
            style="cursor: pointer;">

          <td>
            <span class="materia-badge"
                  [ngStyle]="{'background': materiaColor(t.nombre_materia)}">
              {{ t.nombre_materia || 'Sin materia' }}
              <small *ngIf="t.id_materia === null">(Sin asignar)</small>
            </span>
          </td>

          <td class="titulo-col">
            <div class="titulo">{{ t.titulo }}</div>
            <div class="instrucciones">
              {{ (t.instrucciones || 'Sin instrucciones detalladas') }}
            </div>

            <div class="archivo-indicador" *ngIf="t.archivo_adjunto">
              <span class="archivo-badge">
                <span class="emoji">{{ obtenerIconoArchivo(t.archivo_adjunto) }}</span>
                Material adjunto
              </span>
            </div>
          </td>

          <td>
            <strong>{{ formatearFecha(t.fecha_cierre) }}</strong>
          </td>

          <td>
            <span class="badge"
                  [class.activa]="permiteTarde(t)"
                  [class.inactiva]="!permiteTarde(t)">
              {{ permiteTarde(t) ? 'Permitido' : 'No permitido' }}
            </span>
          </td>

          <td>
            <span class="badge"
                  [class.activa]="estaActiva(t)"
                  [class.inactiva]="!estaActiva(t)">
              {{ estaActiva(t) ? 'Activa' : 'Inactiva' }}
            </span>
          </td>

          <td>
            <span class="entregas-count">
              {{ t.total_entregas || 0 }} entregas
            </span>
          </td>

          <td>
            <div class="acciones-rapidas">
              <button class="btn btn-ver"
                      (click)="seleccionarTarea(t); $event.stopPropagation()">
                <span class="emoji">ğŸ‘ï¸</span> Ver
              </button>
              
              <button class="btn btn-warning"
                      (click)="abrirModalEditarTarea(); $event.stopPropagation()"
                      [disabled]="!t.id_materia">
                <span class="emoji">âœï¸</span> Editar
              </button>
              
              <button class="btn btn-danger"
                      (click)="eliminarTareaActual(); $event.stopPropagation()">
                <span class="emoji">ğŸ—‘ï¸</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Estado vacÃ­o -->
    <div class="estado-vacio" *ngIf="tareasFiltradas.length === 0 && !loadingTareas">
      <span class="emoji">ğŸ“­</span>
      <h3>No hay tareas registradas</h3>
      <p>No se encontraron tareas para el filtro seleccionado.</p>
      <br>
      <button class="btn btn-primary" (click)="abrirModalNuevaTarea()">
        <span class="emoji">â•</span> Crear mi primera tarea
      </button>
    </div>
  </section>

  <!-- Detalle de tarea -->
  <section class="card detalle" *ngIf="tareaSeleccionada && !loadingTareas">
    <div class="card-header">
      <div>
        <h2 class="card-title">
          <span class="emoji">ğŸ“‘</span> Entregas: {{ tareaSeleccionada.titulo }}
        </h2>
        <p class="card-desc">
          <strong>LÃ­mite:</strong> {{ formatearFecha(tareaSeleccionada.fecha_cierre) }} Â· 
          <strong>Entrega tarde:</strong> {{ permiteTarde(tareaSeleccionada) ? 'Permitida' : 'No permitida' }} Â· 
          <strong>Estado:</strong> {{ estaActiva(tareaSeleccionada) ? 'Activa' : 'Inactiva' }} Â· 
          <strong>Total entregas:</strong> {{ entregas.length }}
          <span *ngIf="loadingEntregas" class="loading-text"> (cargando entregas...)</span>
        </p>
      </div>

      <span class="materia-badge"
            [ngStyle]="{'background': materiaColor(tareaSeleccionada.nombre_materia)}">
        {{ tareaSeleccionada.nombre_materia || 'Sin materia' }}
        <small *ngIf="tareaSeleccionada.id_materia === null">(Sin asignar)</small>
      </span>
    </div>

    <!-- Mensaje de carga de entregas -->
    <div *ngIf="loadingEntregas" class="loading-entregas">
      <div class="spinner small"></div>
      <p>Cargando entregas...</p>
    </div>

    <!-- Mensaje de error de entregas -->
    <div *ngIf="errorEntregas && !loadingEntregas" class="error-message">
      <span class="emoji">âš ï¸</span> {{ errorEntregas }}
      <button class="btn btn-neutral" (click)="cargarEntregas(tareaSeleccionada.id_tarea)">Reintentar</button>
    </div>

    <!-- Archivo adjunto -->
    <div class="archivo-adjunto-tarea" *ngIf="tareaSeleccionada.archivo_adjunto && !loadingEntregas">
      <div class="mini-titulo">
        <span class="emoji">ğŸ“</span> Material de apoyo
      </div>
      <div class="archivo-adjunto-info">
        <span class="archivo-adjunto-icono">{{ obtenerIconoArchivo(tareaSeleccionada.archivo_adjunto) }}</span>
        <div class="archivo-adjunto-details">
          <div class="archivo-adjunto-nombre">
            {{ getNombreArchivo(tareaSeleccionada.archivo_adjunto) }}
          </div>
          <div class="archivo-adjunto-desc">
            Archivo disponible para descarga
          </div>
        </div>
        <a class="btn-archivo-descargar"
           [href]="fileUrl(tareaSeleccionada.archivo_adjunto)"
           target="_blank"
           download>
          <span class="emoji">ğŸ“¥</span> Descargar
        </a>
      </div>
    </div>

    <!-- EstadÃ­sticas -->
    <div class="estadisticas-rapidas" *ngIf="entregas.length > 0 && !loadingEntregas">
      <div class="estadistica-item">
        <div class="estadistica-valor">{{ estadisticasEntregas.total }}</div>
        <div class="estadistica-label">Total</div>
      </div>
      <div class="estadistica-item">
        <div class="estadistica-valor text-success">{{ estadisticasEntregas.revisadas }}</div>
        <div class="estadistica-label">Revisadas</div>
      </div>
      <div class="estadistica-item">
        <div class="estadistica-valor text-info">{{ estadisticasEntregas.entregadas }}</div>
        <div class="estadistica-label">Entregadas</div>
      </div>
      <div class="estadistica-item">
        <div class="estadistica-valor text-warning">{{ estadisticasEntregas.pendientes }}</div>
        <div class="estadistica-label">Pendientes</div>
      </div>
    </div>

    <!-- Tabla de entregas -->
    <table class="tabla tabla-entregas"
           *ngIf="entregas.length > 0 && !loadingEntregas">
      <thead>
        <tr>
          <th width="200">Estudiante</th>
          <th width="120">Estado</th>
          <th width="180">Fecha Entrega</th>
          <th width="100">CalificaciÃ³n</th>
          <th>Comentario</th>
          <th width="150">AcciÃ³n</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let e of entregas">
          
          <td>
            <div class="alumno-nombre">{{ e.nombre_alumno || 'Nombre no disponible' }}</div>
          </td>

          <td>
            <span [ngClass]="estadoClass(e.estado)">
              {{ e.estado || 'PENDIENTE' }}
            </span>
          </td>

          <td>
            {{ formatearFecha(e.fecha_entrega) || 'No entregada' }}
          </td>

          <td>
            <span *ngIf="e.calificacion !== null && e.calificacion !== undefined" 
                  class="nota-destacada">
              {{ e.calificacion }}/10
            </span>
            <span *ngIf="e.calificacion === null || e.calificacion === undefined">
              â€”
            </span>
          </td>

          <td>
            <div class="comentario-alumno" *ngIf="e.comentario_alumno">
              {{ e.comentario_alumno }}
            </div>
            <div class="sin-comentario" *ngIf="!e.comentario_alumno">
              Sin comentario
            </div>
          </td>

          <td>
            <button class="btn btn-calificar"
                    (click)="abrirModalCalificar(e)">
              <span class="emoji">âœï¸</span> Calificar
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Estado vacÃ­o entregas -->
    <div class="estado-vacio" *ngIf="entregas.length === 0 && !loadingEntregas && !errorEntregas">
      <span class="emoji">ğŸ‘¥</span>
      <h3>No hay entregas aÃºn</h3>
      <p>NingÃºn estudiante ha entregado esta tarea.</p>
    </div>
  </section>

  <!-- =========================================================
       MODALES
  ============================================================ -->
  
  <!-- Modal Calificar Entrega - VERSIÃ“N MEJORADA -->
  <div class="modal-backdrop modal-calificar" *ngIf="modalCalificarAbierto">
    <div class="modal-card">
      <div class="modal-header">
        <h3>
          <span class="emoji">âœï¸</span> Calificar Entrega
        </h3>
        <p class="modal-subtitle">
          Calificando entrega de <strong>{{ entregaEditando?.nombre_alumno }}</strong>
        </p>
      </div>
      
      <div class="modal-body" *ngIf="entregaEditando">
        <div class="form-group">
          <label class="label-required">CalificaciÃ³n (0-10)</label>
          <input type="number" 
                 [(ngModel)]="notaTemp" 
                 min="0" 
                 max="10" 
                 step="0.1" 
                 placeholder="Ej: 8.5"
                 class="input-calificacion">
          <div class="form-hint">
            <span class="emoji">ğŸ’¡</span> Ingresa un valor entre 0 y 10
          </div>
        </div>
        
        <div class="form-group">
          <label>Comentario para el estudiante</label>
          <textarea [(ngModel)]="comentarioTemp" 
                    rows="4" 
                    placeholder="Escribe un comentario constructivo para retroalimentaciÃ³n..."
                    class="textarea-comentario"></textarea>
          <div class="form-hint">
            <span class="emoji">ğŸ“</span> Opcional, pero recomendado
          </div>
        </div>
      </div>
      
      <div class="modal-actions-tarea">
        <button class="btn-cancelar" (click)="cerrarModalCalificar()">
          <span class="emoji">â†</span> Cancelar
        </button>
        <button class="btn-guardar" (click)="guardarCalificacion()">
          <span class="emoji">âœ…</span> Guardar CalificaciÃ³n
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Tarea (Crear/Editar) -->
  <div class="modal-backdrop modal-tarea" 
       [class.modal-tarea-nueva]="!editandoTarea"
       [class.modal-tarea-editar]="editandoTarea"
       *ngIf="modalTareaAbierto">
    
    <div class="modal-card modal-wide">
      <div class="modal-header">
        <h3>
          <span class="emoji">{{ editandoTarea ? 'âœï¸' : 'â•' }}</span>
          {{ editandoTarea ? 'Editar Tarea' : 'Nueva Tarea' }}
        </h3>
        <p class="modal-subtitle">
          {{ editandoTarea ? 'Modifica los detalles de la tarea' : 'Crea una nueva tarea para tus estudiantes' }}
        </p>
      </div>
      
      <div class="modal-body">
        <form class="tarea-form" (ngSubmit)="guardarTarea()">
          
          <!-- SecciÃ³n TÃ­tulo -->
          <div class="form-section titulo-section">
            <h4 class="section-title section-title-required">
              <span class="emoji">ğŸ“</span> TÃ­tulo de la Tarea
            </h4>
            <div class="form-group required">
              <input type="text" 
                     [(ngModel)]="formTarea.titulo" 
                     class="input-titulo"
                     placeholder="Ej: Proyecto de Historia - Culturas PrehispÃ¡nicas"
                     required
                     name="titulo"
                     maxlength="200">
            </div>
          </div>
          
          <!-- SecciÃ³n Materia -->
          <div class="form-section materia-section">
            <h4 class="section-title section-title-required">
              <span class="emoji">ğŸ“</span> Materia Asignada
            </h4>
            <div class="form-group required select-materia">
              <select [(ngModel)]="formTarea.id_materia" 
                      required 
                      name="materia"
                      class="select-materia-input">
                <option value="" disabled selected>Selecciona una materia</option>
                <option *ngFor="let m of materias" 
                        [value]="m.id_materia">
                  {{ m.nombre }}
                </option>
              </select>
              
              <div class="materia-preview" *ngIf="formTarea.id_materia">
                <span class="color-indicator" 
                      [style.background-color]="getMateriaColor(formTarea.id_materia)"></span>
                {{ getMateriaNombre(formTarea.id_materia) }}
              </div>

              <div class="form-hint" *ngIf="!formTarea.id_materia && editandoTarea && !tareaSeleccionada?.id_materia">
                <span class="emoji">âš ï¸</span> Esta tarea actualmente no tiene materia asignada
              </div>
            </div>
          </div>
          
          <!-- SecciÃ³n Instrucciones -->
          <div class="form-section instrucciones-section">
            <h4 class="section-title">
              <span class="emoji">ğŸ“‹</span> Instrucciones Detalladas
            </h4>
            <div class="form-group">
              <textarea [(ngModel)]="formTarea.instrucciones" 
                        class="textarea-instrucciones"
                        placeholder="Describe detalladamente las instrucciones..."
                        rows="5"
                        name="instrucciones"></textarea>
            </div>
          </div>
          
          <!-- SecciÃ³n Fecha -->
          <div class="form-section fecha-section">
            <h4 class="section-title section-title-required">
              <span class="emoji">â°</span> Fecha LÃ­mite de Entrega
            </h4>
            <div class="fecha-container">
              <div class="input-fecha form-group required">
                <input type="datetime-local" 
                       [(ngModel)]="fechaTemporal" 
                       [min]="fechaMinima"
                       (change)="actualizarFechaDesdeInput()"
                       required
                       name="fecha">
              </div>
              <div class="fecha-info">
                Fecha seleccionada:
                <span class="countdown">{{ formatearFecha(formTarea.fecha_cierre) }}</span>
              </div>
            </div>
            
            <div class="form-group">
              <label>Trimestre:</label>
              <select [(ngModel)]="formTarea.trimestre" name="trimestre">
                <option value="1">1Â° Trimestre</option>
                <option value="2">2Â° Trimestre</option>
                <option value="3">3Â° Trimestre</option>
              </select>
            </div>
          </div>
          
          <!-- Configuraciones -->
          <div class="form-section configuracion-section">
            <h4 class="section-title">
              <span class="emoji">âš™ï¸</span> Configuraciones
            </h4>
            <div class="config-row">
              <div class="config-item">
                <label>
                  <div class="config-icon">ğŸ•’</div>
                  <div>
                    Permitir entrega tarde
                    <div class="config-desc">
                      Los estudiantes podrÃ¡n entregar despuÃ©s de la fecha lÃ­mite
                    </div>
                  </div>
                  <input type="checkbox" 
                         [(ngModel)]="formTarea.permitir_entrega_tarde"
                         name="permiteTarde">
                </label>
              </div>
              
              <div class="config-item">
                <label>
                  <div class="config-icon">ğŸ“¢</div>
                  <div>
                    Tarea activa
                    <div class="config-desc">
                      La tarea serÃ¡ visible para los estudiantes
                    </div>
                  </div>
                  <input type="checkbox" 
                         [(ngModel)]="formTarea.activa"
                         name="activa">
                </label>
              </div>
            </div>
          </div>
          
          <!-- Archivo adjunto -->
          <div class="form-section archivo-section">
            <h4 class="section-title">
              <span class="emoji">ğŸ“</span> Material de apoyo (opcional)
            </h4>
            <div class="file-upload-area" [class.has-file]="archivoSeleccionado || rutaArchivoAdjunto">
              <div class="upload-icon">ğŸ“¤</div>
              <div class="upload-text">Arrastra y suelta tu archivo aquÃ­</div>
              <div class="upload-subtext">o haz clic para seleccionar</div>
              <div class="formatos">Formatos: PDF, DOC, JPG, PNG, ZIP (MÃ¡x. 20MB)</div>
              <input type="file" 
                     (change)="onFileSelected($event)" 
                     accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.zip,.rar">
              
              <div *ngIf="archivoSeleccionado" class="file-info">
                <div class="file-icon">{{ obtenerIconoArchivo(archivoSeleccionado.name) }}</div>
                <div class="file-details">
                  <div class="file-name">{{ archivoSeleccionado.name }}</div>
                  <div class="file-size">{{ (archivoSeleccionado.size / 1024 / 1024).toFixed(2) }} MB</div>
                </div>
                <button type="button" class="btn-remove" (click)="eliminarArchivoAdjunto()">âœ•</button>
              </div>
              
              <div *ngIf="rutaArchivoAdjunto && !archivoSeleccionado" class="file-info">
                <div class="file-icon">{{ obtenerIconoArchivo(rutaArchivoAdjunto) }}</div>
                <div class="file-details">
                  <div class="file-name">{{ getNombreArchivo(rutaArchivoAdjunto) }}</div>
                  <div class="file-size">Archivo existente</div>
                </div>
                <button type="button" class="btn-remove" (click)="eliminarArchivoAdjunto()">âœ•</button>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-actions-tarea">
        <button class="btn-cancelar" (click)="cerrarModalTarea()">Cancelar</button>
        <button class="btn-guardar" 
                (click)="guardarTarea()" 
                [disabled]="guardandoTarea">
          <span *ngIf="guardandoTarea" class="spinner-button"></span>
          {{ guardandoTarea ? 'Guardando...' : (editandoTarea ? 'Actualizar' : 'Crear') }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Nueva Materia - VERSIÃ“N MEJORADA -->
  <div class="modal-backdrop modal-materia-nueva" *ngIf="modalMateriasAbierto && !editandoMateria">
    <div class="modal-card modal-wide">
      <div class="modal-header">
        <h3>
          <span class="emoji">ğŸ“</span> Nueva Materia
        </h3>
        <p class="modal-subtitle">
          Crea una nueva materia acadÃ©mica
        </p>
      </div>
      
      <div class="modal-body">
        <!-- Formulario de materia -->
        <div class="form-section">
          <h4 class="section-title section-title-required">
            <span class="emoji">ğŸ“</span> Nombre de la Materia
          </h4>
          <div class="form-group required">
            <input type="text" 
                  [(ngModel)]="materiaForm.nombre" 
                  class="input-titulo"
                  placeholder="Ej: MatemÃ¡ticas, Ciencias, Historia..."
                  required
                  maxlength="100">
          </div>
        </div>
        
        <div class="form-section">
          <h4 class="section-title">
            <span class="emoji">ğŸ“‹</span> DescripciÃ³n
          </h4>
          <div class="form-group">
            <textarea [(ngModel)]="materiaForm.descripcion" 
                     class="textarea-instrucciones"
                     placeholder="Describe brevemente la materia..."
                     rows="3"></textarea>
          </div>
        </div>
        
        <div class="form-section">
          <h4 class="section-title">
            <span class="emoji">ğŸ¨</span> PersonalizaciÃ³n
          </h4>
          <div class="form-row">
            <div class="form-group">
              <label class="label-required">Color</label>
              <div class="color-picker">
                <input type="color" 
                      [(ngModel)]="materiaForm.color"
                      class="color-input">
                <span class="color-preview" 
                      [style.background-color]="materiaForm.color || '#667eea'"></span>
              </div>
            </div>
            
            <div class="form-group">
              <label class="label-required">Icono</label>
              <input type="text" 
                    [(ngModel)]="materiaForm.icono"
                    class="input-icono"
                    placeholder="ğŸ“š"
                    maxlength="2">
            </div>
          </div>
        </div>
        
        <!-- Lista de materias existentes -->
        <div class="form-section" *ngIf="materias.length > 0">
          <h4 class="section-title">
            <span class="emoji">ğŸ“š</span> Materias Existentes
          </h4>
          <div class="materias-list">
            <div *ngFor="let materia of materias" 
                 class="materia-item"
                 [class.selected]="materiaForm.id_materia === materia.id_materia"
                 (click)="editarMateria(materia)">
              <div class="materia-item-color" 
                   [style.background-color]="materia.color || '#667eea'"></div>
              <div class="materia-item-content">
                <div class="materia-item-name">
                  <span class="materia-item-icon">{{ materia.icono || 'ğŸ“š' }}</span>
                  {{ materia.nombre }}
                </div>
                <div class="materia-item-desc" *ngIf="materia.descripcion">
                  {{ materia.descripcion }}
                </div>
              </div>
              <button class="btn btn-danger btn-sm" 
                      (click)="eliminarMateria(materia); $event.stopPropagation()">
                <span class="emoji">ğŸ—‘ï¸</span>
              </button>
            </div>
          </div>
        </div>
        
        <div *ngIf="errorMateriaModal" class="error-message">
          <span class="emoji">âš ï¸</span> {{ errorMateriaModal }}
        </div>
      </div>
      
      <div class="modal-actions-tarea">
        <button class="btn-cancelar" (click)="cerrarModalMaterias()">
          <span class="emoji">â†</span> Cancelar
        </button>
        <button class="btn-guardar" (click)="guardarMateria()">
          <span class="emoji">â•</span> Crear Materia
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Materia -->
  <div class="modal-backdrop modal-materias" *ngIf="modalMateriasAbierto && editandoMateria">
    <div class="modal-card modal-wide">
      <div class="modal-header">
        <h3>
          <span class="emoji">ğŸ“</span>
          Editar Materia
        </h3>
        <p class="modal-subtitle">
          Modifica los detalles de la materia
        </p>
      </div>
      
      <div class="modal-body">
        <!-- Formulario de materia -->
        <div class="form-section">
          <h4 class="section-title section-title-required">
            <span class="emoji">ğŸ“</span> Nombre de la Materia
          </h4>
          <div class="form-group required">
            <input type="text" 
                  [(ngModel)]="materiaForm.nombre" 
                  class="input-titulo"
                  placeholder="Ej: MatemÃ¡ticas, Ciencias, Historia..."
                  required
                  maxlength="100">
          </div>
        </div>
        
        <div class="form-section">
          <h4 class="section-title">
            <span class="emoji">ğŸ“‹</span> DescripciÃ³n
          </h4>
          <div class="form-group">
            <textarea [(ngModel)]="materiaForm.descripcion" 
                     class="textarea-instrucciones"
                     placeholder="Describe la materia..."
                     rows="3"></textarea>
          </div>
        </div>
        
        <div class="form-section">
          <h4 class="section-title">
            <span class="emoji">ğŸ¨</span> PersonalizaciÃ³n
          </h4>
          <div class="form-row">
            <div class="form-group">
              <label class="label-required">Color</label>
              <div class="color-picker">
                <input type="color" 
                      [(ngModel)]="materiaForm.color"
                      class="color-input">
                <span class="color-preview" 
                      [style.background-color]="materiaForm.color || '#667eea'"></span>
              </div>
            </div>
            
            <div class="form-group">
              <label class="label-required">Icono</label>
              <input type="text" 
                    [(ngModel)]="materiaForm.icono"
                    class="input-icono"
                    placeholder="ğŸ“š, ğŸ“, ğŸ”¬, ğŸ“–"
                    maxlength="2">
            </div>
          </div>
        </div>
        
        <!-- Lista de materias existentes -->
        <div class="form-section" *ngIf="materias.length > 0">
          <h4 class="section-title">
            <span class="emoji">ğŸ“š</span> Materias Existentes
          </h4>
          <div class="materias-list">
            <div *ngFor="let materia of materias" 
                 class="materia-item"
                 [class.selected]="materiaForm.id_materia === materia.id_materia"
                 (click)="editarMateria(materia)">
              <div class="materia-item-color" 
                   [style.background-color]="materia.color || '#667eea'"></div>
              <div class="materia-item-content">
                <div class="materia-item-name">
                  <span class="materia-item-icon">{{ materia.icono || 'ğŸ“š' }}</span>
                  {{ materia.nombre }}
                </div>
                <div class="materia-item-desc" *ngIf="materia.descripcion">
                  {{ materia.descripcion }}
                </div>
              </div>
              <button class="btn btn-danger btn-sm" 
                      (click)="eliminarMateria(materia); $event.stopPropagation()">
                <span class="emoji">ğŸ—‘ï¸</span>
              </button>
            </div>
          </div>
        </div>
        
        <div *ngIf="errorMateriaModal" class="error-message">
          <span class="emoji">âš ï¸</span> {{ errorMateriaModal }}
        </div>
      </div>
      
      <div class="modal-actions-tarea">
        <button class="btn-cancelar" (click)="cerrarModalMaterias()">Cancelar</button>
        <button class="btn-guardar" (click)="guardarMateria()">
          Actualizar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Alerta -->
  <div class="modal-backdrop" *ngIf="modalAlertaAbierto">
    <div class="modal-card">
      <h3>{{ alertaTitulo }}</h3>
      <div [ngClass]="{
        'text-success': alertaTipo === 'success',
        'text-error': alertaTipo === 'error',
        'text-info': alertaTipo === 'info'
      }">
        {{ alertaMensaje }}
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" (click)="cerrarAlerta()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal ConfirmaciÃ³n -->
  <div class="modal-backdrop" *ngIf="modalConfirmacionAbierto">
    <div class="modal-card">
      <h3>{{ confirmacionTitulo }}</h3>
      <div [innerHTML]="confirmacionMensaje"></div>
      <div class="modal-actions">
        <button class="btn btn-neutral" (click)="cerrarConfirmacion()">Cancelar</button>
        <button class="btn btn-danger" (click)="aceptarConfirmacion()">Confirmar</button>
      </div>
    </div>
  </div>

</div>