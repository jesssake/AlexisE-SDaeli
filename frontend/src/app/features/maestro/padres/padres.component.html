<!-- C:\Codigos\HTml\gestion-educativa\frontend\src\app\features\maestro\padres\padres.component.html -->
<div class="chat-container">
  <!-- Header principal -->
  <div class="chat-header">
    <div class="header-main">
      <h2>ğŸ’¬ Chat con Padres</h2>
      <div class="server-status" [class]="getServerStatusClass()">
        {{serverStatus}}
        <button class="btn-refresh" (click)="verificarSaludServidor()" title="Verificar servidor">
          ğŸ”„
        </button>
      </div>
    </div>
    
    <div class="estadisticas" *ngIf="estadisticas">
      <div class="stat-group">
        <span class="stat" title="Total de tutores">
          ğŸ‘¥ {{estadisticas.total_tutores}}
        </span>
        <span class="stat" title="Total de mensajes">
          ğŸ’¬ {{estadisticas.total_mensajes}}
        </span>
        <span class="stat unread-stat" *ngIf="estadisticas.mensajes_no_leidos > 0" 
              title="Mensajes no leÃ­dos">
          ğŸ”´ {{estadisticas.mensajes_no_leidos}}
        </span>
        <span class="stat" title="Ãšltima actividad">
          â° {{formatearFechaCorta(estadisticas.ultima_actividad)}}
        </span>
      </div>
    </div>
  </div>

  <div class="chat-layout">
    <!-- Panel izquierdo: Lista de conversaciones -->
    <div class="conversaciones-list">
      <div class="list-header">
        <h3>Conversaciones</h3>
        <div class="list-actions">
          <button class="btn-refresh" (click)="cargarConversaciones()" [disabled]="loading" 
                  title="Recargar conversaciones">
            ğŸ”„ {{loading ? 'Cargando...' : ''}}
          </button>
          <span class="total-conversations" *ngIf="!loading">
            {{conversaciones.length}}
          </span>
        </div>
      </div>

      <!-- Loading state -->
      <div class="loading-state" *ngIf="loading && conversaciones.length === 0">
        <div class="spinner"></div>
        <p>Cargando conversaciones...</p>
      </div>
      
      <!-- Lista de conversaciones -->
      <div class="conversaciones" *ngIf="!loading || conversaciones.length > 0">
        <div 
          *ngFor="let conversacion of conversaciones" 
          class="conversacion-item"
          [class.active]="conversacionSeleccionada?.tutor_id === conversacion.tutor_id"
          [class.has-unread]="conversacion.mensajes_no_leidos > 0"
          (click)="seleccionarConversacion(conversacion)">
          
          <div class="conversacion-avatar">
            <div class="avatar">{{conversacion.tutor_nombre.charAt(0)}}</div>
          </div>
          
          <div class="conversacion-content">
            <div class="conversacion-header">
              <strong class="tutor-name">{{conversacion.tutor_nombre}}</strong>
              <div class="conversacion-meta">
                <span class="badge" *ngIf="conversacion.mensajes_no_leidos > 0">
                  {{conversacion.mensajes_no_leidos}}
                </span>
                <span class="time">
                  {{formatearFechaCorta(conversacion.fecha_ultimo_mensaje)}}
                </span>
              </div>
            </div>
            
            <div class="nino-info">
              <span class="child-icon">ğŸ‘¶</span>
              {{conversacion.nino_nombre}}
            </div>
            
            <div class="ultimo-mensaje" *ngIf="conversacion.ultimo_mensaje">
              {{conversacion.ultimo_mensaje.length > 60 ? 
                (conversacion.ultimo_mensaje.substring(0, 60) + '...') : 
                conversacion.ultimo_mensaje}}
            </div>
            
            <div class="contact-info">
              <span class="email" title="Email">ğŸ“§</span>
              <span class="phone" title="TelÃ©fono">ğŸ“</span>
            </div>
          </div>
        </div>

        <!-- Sin conversaciones -->
        <div class="no-conversations" *ngIf="conversaciones.length === 0 && !loading">
          <div class="empty-state">
            <div class="empty-icon">ğŸ’¬</div>
            <p>No hay conversaciones activas</p>
            <p class="empty-subtext">Los mensajes aparecerÃ¡n aquÃ­ cuando los padres te escriban</p>
            <button class="btn-empty" (click)="recargarTodo()">
              ğŸ”„ Recargar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel derecho: Ãrea de chat -->
    <div class="chat-area" *ngIf="conversacionSeleccionada; else noSelection">
      <!-- Header de conversaciÃ³n seleccionada -->
      <div class="chat-header-selected">
        <div class="selected-header-main">
          <button class="btn-back" (click)="conversacionSeleccionada = null" title="Volver">
            â†
          </button>
          <div class="selected-tutor-info">
            <h3>{{conversacionSeleccionada.tutor_nombre}}</h3>
            <div class="tutor-details">
              <span class="detail-item" title="Email">
                ğŸ“§ {{conversacionSeleccionada.tutor_email}}
              </span>
              <span class="detail-item" title="TelÃ©fono">
                ğŸ“ {{conversacionSeleccionada.tutor_telefono}}
              </span>
              <span class="detail-item" title="Estudiante">
                ğŸ‘¶ {{conversacionSeleccionada.nino_nombre}}
              </span>
            </div>
          </div>
        </div>
        
        <div class="selected-actions">
          <button class="btn-action" (click)="cargarMensajes(conversacionSeleccionada.tutor_id)" 
                  title="Recargar mensajes">
            ğŸ”„
          </button>
        </div>
      </div>

      <!-- Ãrea de mensajes -->
      <div class="chat-messages" #chatMessages>
        <!-- Loading mensajes -->
        <div class="loading-messages" *ngIf="loading && mensajes.length === 0">
          <div class="spinner"></div>
          <p>Cargando mensajes...</p>
        </div>
        
        <!-- Mensajes -->
        <div 
          *ngFor="let mensaje of mensajes" 
          class="mensaje"
          [class.mensaje-maestro]="mensaje.tipo_remitente === 'maestro'"
          [class.mensaje-tutor]="mensaje.tipo_remitente === 'tutor'">
          
          <div class="mensaje-avatar" *ngIf="mensaje.tipo_remitente === 'tutor'">
            <div class="avatar">{{mensaje.tutor_nombre.charAt(0)}}</div>
          </div>
          
          <div class="mensaje-content">
            <div class="mensaje-header">
              <strong class="sender-name">
                {{mensaje.tipo_remitente === 'maestro' ? 'TÃº' : mensaje.tutor_nombre}}
              </strong>
              <span class="mensaje-time">{{formatearFecha(mensaje.fecha_envio)}}</span>
            </div>
            
            <div class="mensaje-text">{{mensaje.mensaje}}</div>
            
            <div class="mensaje-footer">
              <span class="estado" *ngIf="mensaje.tipo_remitente === 'maestro'">
                {{mensaje.leido ? 'âœ… LeÃ­do' : 'ğŸ•’ Enviado'}}
              </span>
              <span class="child-name" *ngIf="mensaje.tipo_remitente === 'tutor'">
                ğŸ‘¶ {{mensaje.nino_nombre}}
              </span>
            </div>
          </div>
          
          <div class="mensaje-avatar" *ngIf="mensaje.tipo_remitente === 'maestro'">
            <div class="avatar">T</div>
          </div>
        </div>

        <!-- Sin mensajes -->
        <div class="no-messages" *ngIf="mensajes.length === 0 && !loading">
          <div class="empty-chat">
            <div class="empty-icon">ğŸ’­</div>
            <p>No hay mensajes en esta conversaciÃ³n</p>
            <p class="empty-subtext">EnvÃ­a un mensaje para comenzar</p>
          </div>
        </div>
      </div>

      <!-- Input para enviar mensaje -->
      <div class="chat-input">
        <div class="input-container">
          <textarea 
            [(ngModel)]="nuevoMensaje"
            placeholder="Escribe tu mensaje aquÃ­..."
            (keydown)="onKeyDown($event)"
            rows="2"
            [disabled]="enviando"
            #messageInput>
          </textarea>
          <div class="input-actions">
            <span class="char-count" *ngIf="nuevoMensaje.length > 0">
              {{nuevoMensaje.length}}/1000
            </span>
            <button 
              (click)="enviarMensaje()" 
              [disabled]="!nuevoMensaje.trim() || enviando"
              class="btn-send"
              [class.sending]="enviando">
              <span *ngIf="!enviando">ğŸ“¤ Enviar</span>
              <span *ngIf="enviando">â³ Enviando...</span>
            </button>
          </div>
        </div>
        <div class="input-hint">
          Presiona <kbd>Enter</kbd> para enviar, <kbd>Shift + Enter</kbd> para nueva lÃ­nea
        </div>
      </div>
    </div>

    <!-- Sin conversaciÃ³n seleccionada -->
    <ng-template #noSelection>
      <div class="no-selection">
        <div class="placeholder">
          <div class="placeholder-icon">ğŸ’¬</div>
          <h3>Selecciona una conversaciÃ³n</h3>
          <p>Elige un tutor de la lista para comenzar a chatear</p>
          
          <div class="placeholder-tips" *ngIf="conversaciones.length === 0">
            <div class="tip">
              <strong>ğŸ’¡ Consejo:</strong> Si no ves conversaciones:
            </div>
            <ul>
              <li>Verifica que el servidor estÃ© conectado</li>
              <li>AsegÃºrate de tener mensajes en la base de datos</li>
              <li>Los padres deben haber iniciado una conversaciÃ³n</li>
            </ul>
            <button class="btn-try" (click)="recargarTodo()">
              ğŸ”„ Intentar de nuevo
            </button>
          </div>
          
          <div class="placeholder-stats" *ngIf="estadisticas">
            <div class="stat-card">
              <div class="stat-value">{{estadisticas.total_tutores}}</div>
              <div class="stat-label">Tutores</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">{{estadisticas.total_mensajes}}</div>
              <div class="stat-label">Mensajes</div>
            </div>
            <div class="stat-card" *ngIf="estadisticas.mensajes_no_leidos > 0">
              <div class="stat-value unread">{{estadisticas.mensajes_no_leidos}}</div>
              <div class="stat-label">No leÃ­dos</div>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </div>

  <!-- Mensajes de error -->
  <div class="error-overlay" *ngIf="error">
    <div class="error-message">
      <div class="error-icon">âš ï¸</div>
      <div class="error-content">
        <strong>AtenciÃ³n</strong>
        <p>{{error}}</p>
      </div>
      <button (click)="limpiarError()" class="btn-close-error" title="Cerrar">
        âœ•
      </button>
    </div>
  </div>

  <!-- Estado del servidor (flotante) -->
  <div class="floating-status" [class]="getServerStatusClass()">
    <div class="status-content">
      <span class="status-icon">
        {{serverStatus.includes('ğŸŸ¢') ? 'âœ…' : 
          serverStatus.includes('ğŸ”´') ? 'âŒ' : 'ğŸ”„'}}
      </span>
      <span class="status-text">{{serverStatus}}</span>
      <button class="btn-status-refresh" (click)="verificarSaludServidor()">
        ğŸ”„
      </button>
    </div>
  </div>
</div>