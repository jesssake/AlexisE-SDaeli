<!-- reportes.component.html -->
<div class="reportes-alumno-container" *ngIf="estudianteId > 0; else sinDatos">
  <!-- Encabezado -->
  <div class="header">
    <h1>
      <span class="icon">ğŸ“‹</span>
      Reportes de {{ estudianteNombre }}
    </h1>
    <div class="estudiante-info">
      <p><strong>Tutor:</strong> {{ tutorNombre }}</p>
      <p><strong>Grupo:</strong> {{ grupo }}</p>
      <button class="btn-export" (click)="exportarPDF()" [disabled]="resumen.total === 0">
        ğŸ“„ Exportar PDF
      </button>
    </div>
  </div>

  <!-- Tarjetas KPI -->
  <div class="kpi-cards">
    <div class="kpi-card total">
      <div class="kpi-icon">ğŸ“Š</div>
      <div class="kpi-content">
        <h3>Total Reportes</h3>
        <p class="kpi-value">{{ resumen.total }}</p>
      </div>
    </div>
    
    <div class="kpi-card pendientes">
      <div class="kpi-icon">â³</div>
      <div class="kpi-content">
        <h3>Pendientes</h3>
        <p class="kpi-value">{{ resumen.pendientes }}</p>
        <p class="kpi-percent">{{ obtenerPorcentajePendientes() }}%</p>
      </div>
    </div>
    
    <div class="kpi-card resueltos">
      <div class="kpi-icon">âœ…</div>
      <div class="kpi-content">
        <h3>Resueltos</h3>
        <p class="kpi-value">{{ resumen.resueltos }}</p>
        <p class="kpi-percent">{{ obtenerPorcentajeResueltos() }}%</p>
      </div>
    </div>
    
    <div class="kpi-card prioridad">
      <div class="kpi-icon">âš ï¸</div>
      <div class="kpi-content">
        <h3>Alta Prioridad</h3>
        <p class="kpi-value">{{ resumen.altaPrioridad }}</p>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filtros-section">
    <h3>ğŸ” Filtros</h3>
    <div class="filtros-grid">
      <div class="filtro-group">
        <label>Tipo:</label>
        <select [(ngModel)]="filtroTipo" (change)="aplicarFiltros()">
          <option value="todos">Todos los tipos</option>
          <option *ngFor="let tipo of tiposReporte" [value]="tipo.valor">
            {{ tipo.icono }} {{ tipo.nombre }}
          </option>
        </select>
      </div>
      
      <div class="filtro-group">
        <label>Estado:</label>
        <select [(ngModel)]="filtroEstado" (change)="aplicarFiltros()">
          <option value="todos">Todos los estados</option>
          <option *ngFor="let estado of estadosReporte" [value]="estado.valor">
            {{ estado.nombre }}
          </option>
        </select>
      </div>
      
      <div class="filtro-group">
        <label>Prioridad:</label>
        <select [(ngModel)]="filtroPrioridad" (change)="aplicarFiltros()">
          <option value="todos">Todas las prioridades</option>
          <option *ngFor="let prioridad of nivelesPrioridad" [value]="prioridad.valor">
            {{ prioridad.nombre }}
          </option>
        </select>
      </div>
      
      <div class="filtro-group">
        <label>Mes:</label>
        <select [(ngModel)]="filtroMes" (change)="aplicarFiltros()">
          <option *ngFor="let mes of meses" [value]="mes.valor">{{ mes.nombre }}</option>
        </select>
      </div>
      
      <div class="filtro-group">
        <label>AÃ±o:</label>
        <select [(ngModel)]="filtroAnio" (change)="aplicarFiltros()">
          <option value="">Todos los aÃ±os</option>
          <option *ngFor="let anio of anios" [value]="anio">{{ anio }}</option>
        </select>
      </div>
      
      <div class="filtro-actions">
        <button class="btn-limpiar" (click)="limpiarFiltros()">ğŸ§¹ Limpiar</button>
        <button class="btn-aplicar" (click)="aplicarFiltros()" [disabled]="cargando">
          {{ cargando ? 'Cargando...' : 'ğŸ” Aplicar' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Lista de Reportes -->
  <div class="reportes-list" *ngIf="!cargando; else loading">
    <div *ngIf="reportesFiltrados.length > 0; else sinReportes">
      <div class="reportes-count">
        Mostrando {{ reportesFiltrados.length }} de {{ resumen.total }} reportes
      </div>
      
      <div class="reporte-card" *ngFor="let reporte of reportesFiltrados" 
           [ngClass]="['estado-' + reporte.estado, 'prioridad-' + reporte.prioridad]"
           (click)="abrirModal(reporte)">
        
        <div class="reporte-header">
          <div class="reporte-tipo">
            <span class="tipo-icon">{{ iconoTipo(reporte.tipo) }}</span>
            <span class="tipo-nombre">{{ obtenerNombreTipo(reporte.tipo) }}</span>
          </div>
          
          <div class="reporte-meta">
            <span class="fecha">{{ fechaBonita(reporte.fecha) }}</span>
            <span class="maestro">Por: {{ reporte.maestro || 'Maestro' }}</span>
          </div>
        </div>
        
        <div class="reporte-body">
          <h4 class="motivo">{{ reporte.motivo }}</h4>
          <p class="descripcion">{{ reporte.descripcion }}</p>
        </div>
        
        <div class="reporte-footer">
          <div class="estados">
            <span class="estado-badge" [style.background]="obtenerColorEstado(reporte.estado)">
              {{ reporte.estado }}
            </span>
            <span class="prioridad-badge" [style.background]="obtenerColorPrioridad(reporte.prioridad)">
              {{ reporte.prioridad }}
            </span>
          </div>
          
          <div class="acciones">
            <span class="observaciones-indicator" *ngIf="tieneObservaciones(reporte)" title="Tiene observaciones">
              ğŸ’¬
            </span>
            <button class="btn-ver" (click)="abrirModal(reporte); $event.stopPropagation()">
              ğŸ‘ï¸ Ver Detalles
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Detalles -->
  <div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
    <div class="modal-content" (click)="$event.stopPropagation()" *ngIf="reporteSeleccionado">
      <button class="modal-close" (click)="cerrarModal()">Ã—</button>
      
      <div class="modal-header">
        <h2>
          <span>{{ iconoTipo(reporteSeleccionado.tipo) }}</span>
          Reporte #{{ reporteSeleccionado.id }}
        </h2>
        <div class="modal-subtitle">
          <span class="fecha">{{ fechaBonita(reporteSeleccionado.fecha) }}</span>
          <span class="maestro">Maestro: {{ reporteSeleccionado.maestro }}</span>
        </div>
      </div>
      
      <div class="modal-body">
        <div class="modal-section">
          <h3>ğŸ“‹ InformaciÃ³n General</h3>
          <div class="info-grid">
            <div><strong>Tipo:</strong> {{ obtenerNombreTipo(reporteSeleccionado.tipo) }}</div>
            <div><strong>Estado:</strong> 
              <span class="estado-badge" [style.background]="obtenerColorEstado(reporteSeleccionado.estado)">
                {{ reporteSeleccionado.estado }}
              </span>
            </div>
            <div><strong>Prioridad:</strong> 
              <span class="prioridad-badge" [style.background]="obtenerColorPrioridad(reporteSeleccionado.prioridad)">
                {{ reporteSeleccionado.prioridad }}
              </span>
            </div>
            <div><strong>Grupo:</strong> {{ reporteSeleccionado.grupo || grupo }}</div>
          </div>
        </div>
        
        <div class="modal-section">
          <h3>ğŸ“ Detalles del Reporte</h3>
          <p><strong>Motivo:</strong> {{ reporteSeleccionado.motivo }}</p>
          <p><strong>DescripciÃ³n:</strong></p>
          <div class="descripcion-detallada">{{ reporteSeleccionado.descripcion }}</div>
        </div>
        
        <div class="modal-section" *ngIf="reporteSeleccionado.accionesTomadas">
          <h3>âš¡ Acciones Tomadas por el Maestro</h3>
          <div class="acciones-content">{{ reporteSeleccionado.accionesTomadas }}</div>
        </div>
        
        <div class="modal-section" *ngIf="tieneObservaciones(reporteSeleccionado)">
          <h3>ğŸ’¬ Observaciones Previas</h3>
          <div class="observaciones-content">
            <pre>{{ reporteSeleccionado.observaciones }}</pre>
          </div>
        </div>
        
        <div class="modal-section">
          <h3>â• Agregar ObservaciÃ³n</h3>
          <textarea 
            [(ngModel)]="nuevaObservacion" 
            placeholder="Escribe tu observaciÃ³n, comentario o respuesta aquÃ­..."
            rows="4"
            class="observacion-input">
          </textarea>
          <button 
            class="btn-agregar-observacion" 
            (click)="agregarObservacion()"
            [disabled]="!nuevaObservacion.trim()">
            ğŸ’¾ Guardar ObservaciÃ³n
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- BotÃ³n de debug (solo desarrollo) -->
  <button class="debug-btn" (click)="debugInfo()">ğŸ› Debug</button>
</div>

<!-- Templates -->
<ng-template #loading>
  <div class="loading-container">
    <div class="spinner"></div>
    <p>Cargando reportes...</p>
  </div>
</ng-template>

<ng-template #sinReportes>
  <div class="empty-state">
    <div class="empty-icon">ğŸ“­</div>
    <h3>No hay reportes</h3>
    <p *ngIf="filtroTipo !== 'todos' || filtroEstado !== 'todos' || filtroPrioridad !== 'todos'">
      Intenta cambiar los filtros o seleccionar otro perÃ­odo
    </p>
    <p *ngIf="filtroTipo === 'todos' && filtroEstado === 'todos' && filtroPrioridad === 'todos'">
      {{ estudianteNombre }} no tiene reportes registrados aÃºn
    </p>
  </div>
</ng-template>

<ng-template #sinDatos>
  <div class="error-state">
    <div class="error-icon">âŒ</div>
    <h3>Datos incompletos</h3>
    <p>No se pudieron cargar los datos del estudiante.</p>
    <p>Por favor, inicia sesiÃ³n nuevamente.</p>
    <button class="btn-logout" routerLink="/auth/login">ğŸ” Iniciar SesiÃ³n</button>
  </div>
</ng-template>