<div class="wrap" [class.loading]="cargando()">
  <div class="reportes-alumno">
    <div class="ra-container">
      <!-- =============== HERO =============== -->
      <header class="ra-hero" *ngIf="alumno() as a">
        <div class="ra-avatar">{{ (a.nombre || 'A')[0] | uppercase }}</div>
        <div>
          <h1>Â¡Bienvenido, {{ a.nombre }}!</h1>
          <p>Tu centro de documentaciÃ³n y seguimiento personal.</p>
        </div>
      </header>

      <!-- =============== ALERTAS =============== -->
      <div class="ra-alerts" *ngIf="errorMsg() || okMsg()">
        <div class="ra-alert ra-error" *ngIf="errorMsg()">{{ errorMsg() }}</div>
        <div class="ra-alert ra-ok" *ngIf="okMsg()">{{ okMsg() }}</div>
      </div>

      <!-- =============== KPIs =============== -->
      <section class="ra-kpis" *ngIf="alumno()">
        <div class="ra-card ra-kpi"><span class="lbl">Total</span><span class="val">{{ kpiTotal() }}</span></div>
        <div class="ra-card ra-kpi"><span class="lbl">Pendientes</span><span class="val">{{ kpiPend() }}</span></div>
        <div class="ra-card ra-kpi"><span class="lbl">Revisados</span><span class="val">{{ kpiRev() }}</span></div>
        <div class="ra-card ra-kpi"><span class="lbl">Resueltos</span><span class="val">{{ kpiRes() }}</span></div>
        <div class="ra-card ra-kpi"><span class="lbl">Alta prioridad</span><span class="val">{{ kpiAlta() }}</span></div>
      </section>

      <!-- =============== SELECTOR DE HIJO (si hay varios) =============== -->
      <section class="ra-card ra-filtros" *ngIf="hijos().length > 1">
        <div class="row">
          <label>Alumno</label>
          <select [ngModel]="hijoSeleccionado()" (ngModelChange)="onSeleccionHijo($event)">
            <option [ngValue]="null" disabled>â€” Selecciona â€”</option>
            <option *ngFor="let h of hijos()" [ngValue]="h.id">{{ h.nombre }}</option>
          </select>
        </div>
      </section>

      <!-- =============== FILTROS =============== -->
      <section class="ra-card ra-filtros" *ngIf="alumno()">
        <div class="row">
          <label>Estado</label>
          <select [ngModel]="filtroEstado()" (ngModelChange)="filtroEstado.set($event)">
            <option value="todos">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="revisado">Revisado</option>
            <option value="resuelto">Resuelto</option>
          </select>

          <label>Prioridad</label>
          <select [ngModel]="filtroPrioridad()" (ngModelChange)="filtroPrioridad.set($event)">
            <option value="todas">Todas</option>
            <option value="baja">Baja</option>
            <option value="media">Media</option>
            <option value="alta">Alta</option>
          </select>
        </div>
      </section>

      <!-- =============== LISTA =============== -->
      <ng-container *ngIf="alumno(); else sinAlumno">
        <section class="ra-lista">
          <article class="ra-card ra-reporte" *ngFor="let r of filtrados()">
            <div class="head">
              <div class="ra-avatar sm">{{ (r.estudianteNombre || 'A')[0] | uppercase }}</div>
              <div class="meta">
                <h3>{{ r.estudianteNombre }}</h3>
                <p class="sub">{{ r.motivo }}</p>
              </div>

              <div class="chips">
                <span class="chip estado"
                      [class.p]="r.estado==='pendiente'"
                      [class.r]="r.estado==='revisado'"
                      [class.s]="r.estado==='resuelto'">
                  {{ r.estado | titlecase }}
                </span>
                <span class="chip prio" [class.alta]="r.prioridad==='alta'">{{ r.prioridad | titlecase }}</span>
                <span class="chip folio">Folio: {{ r.folio || 'â€”' }}</span>
                <span class="chip fecha">{{ formatearFecha(r.fecha) }}</span>
              </div>
            </div>

            <p class="desc">{{ r.descripcion }}</p>

            <div class="actions">
              <button class="btn" (click)="descargarWord(r.id)">ðŸ“„ WORD</button>
            </div>
          </article>

          <div class="ra-card ra-sin" *ngIf="!filtrados().length">
            No tienes reportes con esos filtros.
          </div>
        </section>
      </ng-container>

      <!-- =============== SIN ALUMNO =============== -->
      <ng-template #sinAlumno>
        <section class="ra-card ra-no-alumno">
          <h3>No se detectÃ³ alumno.</h3>
          <p>Abre desde el menÃº autenticado o pasa <code>?alumno_id=</code> en la URL.</p>
        </section>
      </ng-template>

    </div>
  </div>
</div>
