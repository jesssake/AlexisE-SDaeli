<div class="page-wrap">
  
  <!-- TÃ­tulo principal -->
  <h1 class="page-title">
    Mis Tareas <span>Panel del Estudiante</span>
  </h1>

  <!-- Barra de navegaciÃ³n -->
  <div class="navegacion-vistas">
    <button class="nav-btn" 
            [class.activo]="vistaActual === 'tareas'"
            (click)="cambiarVista('tareas')">
      <span class="emoji">ğŸ“‹</span> Tareas
    </button>
    
    <button class="nav-btn" 
            [class.activo]="vistaActual === 'entregas'"
            (click)="cambiarVista('entregas')">
      <span class="emoji">ğŸ“¤</span> Mis Entregas
    </button>
    
    <button class="nav-btn" 
            [class.activo]="vistaActual === 'calificaciones'"
            (click)="cambiarVista('calificaciones')">
      <span class="emoji">ğŸ“Š</span> Calificaciones
    </button>
    
    <button class="nav-btn" 
            [class.activo]="vistaActual === 'estadisticas'"
            (click)="cambiarVista('estadisticas')">
      <span class="emoji">ğŸ“ˆ</span> EstadÃ­sticas
    </button>
  </div>

  <!-- VISTA: TAREAS -->
  <section *ngIf="vistaActual === 'tareas'" class="card">
    <div class="card-header">
      <div>
        <h2 class="card-title">
          <span class="emoji">ğŸ“‹</span> Tareas Asignadas
        </h2>
        <p class="card-desc">
          Hola <strong>{{ nombreEstudiante }}</strong>, aquÃ­ estÃ¡n tus tareas activas.
        </p>
      </div>

      <div class="filtros-rapidos">
        <button class="chip" 
                [class.activo]="filtroSeleccionado === 'todas'"
                (click)="setFiltro('todas')">
          <span class="emoji">ğŸ“Š</span> Todas
        </button>
        
        <button class="chip" 
                [class.activo]="filtroSeleccionado === 'pendientes'"
                (click)="setFiltro('pendientes')">
          <span class="emoji">â³</span> Pendientes
        </button>
        
        <button class="chip" 
                [class.activo]="filtroSeleccionado === 'entregadas'"
                (click)="setFiltro('entregadas')">
          <span class="emoji">âœ…</span> Entregadas
        </button>
        
        <button class="chip" 
                [class.activo]="filtroSeleccionado === 'calificadas'"
                (click)="setFiltro('calificadas')">
          <span class="emoji">ğŸ“</span> Calificadas
        </button>
        
        <button class="chip" 
                [class.activo]="filtroSeleccionado === 'vencidas'"
                (click)="setFiltro('vencidas')">
          <span class="emoji">âš ï¸</span> Vencidas
        </button>
      </div>
    </div>

    <!-- Mensaje de carga -->
    <div *ngIf="loadingTareas" class="loading-message">
      <div class="spinner"></div>
      <p>Cargando tareas...</p>
    </div>

    <!-- Mensaje de error -->
    <div *ngIf="errorTareas && !loadingTareas" class="error-message">
      <span class="emoji">âš ï¸</span> {{ errorTareas }}
      <button class="btn btn-neutral" (click)="cargarTareas()">Reintentar</button>
    </div>

    <!-- Lista de tareas -->
    <div class="lista-tareas" *ngIf="!loadingTareas && !errorTareas">
      <div *ngFor="let tarea of tareasFiltradas" 
           class="tarjeta-tarea"
           [class.seleccionada]="tareaSeleccionada?.id_tarea === tarea.id_tarea"
           (click)="seleccionarTarea(tarea)">
        
        <div class="tarea-cabecera">
          <div class="materia-indicador" [style.background-color]="materiaColor(tarea.nombre_materia)">
            {{ tarea.nombre_materia || 'Sin materia' }}
          </div>
          
          <div class="tarea-estado" [ngClass]="estadoClass(tarea.estado_alumno)">
            {{ tarea.estado_alumno || 'PENDIENTE' }}
          </div>
        </div>
        
        <div class="tarea-contenido">
          <h3 class="tarea-titulo">{{ tarea.titulo }}</h3>
          
          <div class="tarea-descripcion">
            {{ truncarTexto(tarea.instrucciones || 'Sin instrucciones detalladas', 150) }}
          </div>
          
          <div class="tarea-metadatos">
            <div class="metadato">
              <span class="emoji">â°</span>
              <strong>Fecha lÃ­mite:</strong> {{ formatearFecha(tarea.fecha_cierre) }}
            </div>
            
            <div class="metadato">
              <span class="emoji">ğŸ“…</span>
              <strong>DÃ­as restantes:</strong> {{ formatoDiasRestantes(tarea) }}
            </div>
            
            <div class="metadato">
              <span class="emoji">ğŸ•’</span>
              <strong>Entrega tarde:</strong> {{ permiteTarde(tarea) ? 'Permitida' : 'No permitida' }}
            </div>
          </div>
        </div>
        
        <div class="tarea-acciones">
          <!-- AcciÃ³n segÃºn estado -->
          <ng-container *ngIf="tarea.id_entrega && tarea.estado_entrega !== 'REVISADO'">
            <button class="btn btn-warning" 
                    (click)="abrirModalEntrega(tarea, true); $event.stopPropagation()">
              <span class="emoji">ğŸ”„</span> Actualizar entrega
            </button>
          </ng-container>
          
          <ng-container *ngIf="!tarea.id_entrega">
            <button class="btn btn-primary" 
                    (click)="abrirModalEntrega(tarea, false); $event.stopPropagation()">
              <span class="emoji">ğŸ“¤</span> Entregar tarea
            </button>
          </ng-container>
          
          <ng-container *ngIf="tarea.id_entrega && tarea.estado_entrega === 'REVISADO'">
            <div class="calificacion-display">
              <span class="emoji">ğŸ“</span>
              <strong>CalificaciÃ³n:</strong> 
              <span class="nota-destacada">{{ tarea.calificacion }}/10</span>
            </div>
          </ng-container>
          
          <button class="btn btn-ver" (click)="seleccionarTarea(tarea); $event.stopPropagation()">
            <span class="emoji">ğŸ‘ï¸</span> Ver detalles
          </button>
        </div>
      </div>
    </div>

    <!-- Estado vacÃ­o -->
    <div *ngIf="tareasFiltradas.length === 0 && !loadingTareas && !errorTareas" class="estado-vacio">
      <span class="emoji">ğŸ‰</span>
      <h3>Â¡No hay tareas {{ filtroSeleccionado !== 'todas' ? filtroSeleccionado : '' }}!</h3>
      <p *ngIf="filtroSeleccionado === 'todas'">No tienes tareas asignadas en este momento.</p>
      <p *ngIf="filtroSeleccionado !== 'todas'">No hay tareas que coincidan con este filtro.</p>
    </div>
  </section>

  <!-- VISTA: MIS ENTREGAS -->
  <section *ngIf="vistaActual === 'entregas'" class="card">
    <div class="card-header">
      <h2 class="card-title">
        <span class="emoji">ğŸ“¤</span> Mis Entregas
      </h2>
      <p class="card-desc">
        Historial de todas las tareas que has entregado.
      </p>
    </div>

    <!-- Mensaje de carga -->
    <div *ngIf="loadingEntregas" class="loading-message">
      <div class="spinner"></div>
      <p>Cargando entregas...</p>
    </div>

    <!-- Tabla de entregas -->
    <table class="tabla" *ngIf="misEntregas.length > 0 && !loadingEntregas">
      <thead>
        <tr>
          <th width="200">Tarea</th>
          <th width="120">Estado</th>
          <th width="150">Fecha Entrega</th>
          <th width="100">CalificaciÃ³n</th>
          <th width="200">Comentario del Docente</th>
          <th width="150">Archivo</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let entrega of misEntregas">
          <td>
            <strong>{{ entrega.titulo || 'Sin tÃ­tulo' }}</strong>
            <div class="materia-pequeÃ±a" *ngIf="entrega.color_materia" [style.color]="entrega.color_materia">
              {{ entrega.nombre_materia || '' }}
            </div>
            <div class="materia-pequeÃ±a" *ngIf="!entrega.color_materia">
              {{ entrega.nombre_materia || '' }}
            </div>
          </td>

          <td>
            <span [ngClass]="estadoClass(entrega.estado)">
              {{ entrega.estado }}
            </span>
          </td>

          <td>
            {{ formatearFecha(entrega.fecha_entrega) || 'No especificada' }}
            <div *ngIf="entrega.entregada_tarde" class="text-warning">
              <small>Entregada tarde</small>
            </div>
          </td>

          <td>
            <span *ngIf="entrega.calificacion !== null && entrega.calificacion !== undefined" 
                  class="nota-destacada">
              {{ entrega.calificacion }}/10
            </span>
            <span *ngIf="entrega.calificacion === null || entrega.calificacion === undefined">
              â€”
            </span>
          </td>

          <td>
            <div class="comentario-docente" *ngIf="entrega.comentario_docente">
              {{ entrega.comentario_docente }}
            </div>
            <div class="sin-comentario" *ngIf="!entrega.comentario_docente">
              Sin comentario
            </div>
          </td>

          <td>
            <a *ngIf="entrega.archivo_entrega" 
               [href]="fileUrl(entrega.archivo_entrega)" 
               target="_blank"
               class="btn-descargar">
              <span class="emoji">ğŸ“¥</span> Descargar
            </a>
            <span *ngIf="!entrega.archivo_entrega">
              â€”
            </span>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Estado vacÃ­o entregas -->
    <div *ngIf="misEntregas.length === 0 && !loadingEntregas" class="estado-vacio">
      <span class="emoji">ğŸ“­</span>
      <h3>No has entregado ninguna tarea</h3>
      <p>Ve a la secciÃ³n de "Tareas" para entregar tus asignaciones.</p>
    </div>
  </section>

  <!-- VISTA: CALIFICACIONES -->
  <section *ngIf="vistaActual === 'calificaciones'" class="card">
    <div class="card-header">
      <h2 class="card-title">
        <span class="emoji">ğŸ“Š</span> Mis Calificaciones
      </h2>
      <p class="card-desc">
        Historial de calificaciones recibidas.
      </p>
    </div>

    <!-- Mensaje de carga -->
    <div *ngIf="loadingCalificaciones" class="loading-message">
      <div class="spinner"></div>
      <p>Cargando calificaciones...</p>
    </div>

    <!-- Lista de calificaciones -->
    <div class="lista-calificaciones" *ngIf="calificaciones.length > 0 && !loadingCalificaciones">
      <div *ngFor="let calificacion of calificaciones" class="tarjeta-calificacion">
        <div class="calificacion-cabecera" [style.background-color]="calificacion.color_materia">
          <div class="calificacion-materia">
            <span class="emoji">ğŸ“š</span> {{ calificacion.nombre_materia }}
          </div>
          <div class="calificacion-fecha">
            {{ formatearFecha(calificacion.fecha_entrega) }}
          </div>
        </div>
        
        <div class="calificacion-contenido">
          <h3 class="calificacion-titulo">{{ calificacion.titulo }}</h3>
          
          <div class="calificacion-puntaje">
            <div class="puntaje-numero">{{ calificacion.calificacion }}/10</div>
            <div class="puntaje-nivel" [ngClass]="nivelDesempenoClass(calificacion.nivel_desempeno)">
              {{ calificacion.nivel_desempeno }}
            </div>
          </div>
          
          <div *ngIf="calificacion.comentario_docente" class="calificacion-comentario">
            <strong>Comentario del docente:</strong>
            <p>{{ calificacion.comentario_docente }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Estado vacÃ­o calificaciones -->
    <div *ngIf="calificaciones.length === 0 && !loadingCalificaciones" class="estado-vacio">
      <span class="emoji">ğŸ“</span>
      <h3>No tienes calificaciones aÃºn</h3>
      <p>Las calificaciones aparecerÃ¡n aquÃ­ una vez que tus entregas sean revisadas.</p>
    </div>
  </section>

  <!-- VISTA: ESTADÃSTICAS -->
  <section *ngIf="vistaActual === 'estadisticas'" class="card">
    <div class="card-header">
      <h2 class="card-title">
        <span class="emoji">ğŸ“ˆ</span> Mis EstadÃ­sticas
      </h2>
      <p class="card-desc">
        Resumen de tu desempeÃ±o acadÃ©mico.
      </p>
    </div>

    <!-- Panel de estadÃ­sticas -->
    <div class="estadisticas-grid">
      <div class="estadistica-card">
        <div class="estadistica-icono">ğŸ“‹</div>
        <div class="estadistica-valor">{{ estadisticasTareas.total }}</div>
        <div class="estadistica-label">Total Tareas</div>
      </div>
      
      <div class="estadistica-card">
        <div class="estadistica-icono">âœ…</div>
        <div class="estadistica-valor">{{ estadisticasTareas.entregadas }}</div>
        <div class="estadistica-label">Entregadas</div>
        <div class="estadistica-subtext">{{ estadisticasTareas.porcentajeEntregadas }}%</div>
      </div>
      
      <div class="estadistica-card">
        <div class="estadistica-icono">ğŸ“</div>
        <div class="estadistica-valor">{{ estadisticasTareas.calificadas }}</div>
        <div class="estadistica-label">Calificadas</div>
        <div class="estadistica-subtext">{{ estadisticasTareas.porcentajeCalificadas }}% de entregas</div>
      </div>
      
      <div class="estadistica-card">
        <div class="estadistica-icono">âš ï¸</div>
        <div class="estadistica-valor">{{ estadisticasTareas.vencidas }}</div>
        <div class="estadistica-label">Vencidas</div>
      </div>
    </div>

    <!-- Mensaje de estadÃ­sticas del servidor -->
    <div *ngIf="estadisticas && estadisticas.total_tareas" class="estadisticas-servidor">
      <h3>EstadÃ­sticas Generales</h3>
      <div class="detalles-estadisticas">
        <div><strong>Promedio general:</strong> {{ estadisticas.promedio_general?.toFixed(1) || '0.0' }}/10</div>
        <div><strong>Tareas aprobadas:</strong> {{ estadisticas.tareas_aprobadas || '0' }}</div>
        <div><strong>Tareas reprobadas:</strong> {{ estadisticas.tareas_reprobadas || '0' }}</div>
        <div><strong>Tareas vencidas:</strong> {{ estadisticas.tareas_vencidas || '0' }}</div>
      </div>
    </div>
  </section>

  <!-- =========================================================
       MODALES
  ============================================================ -->
  
  <!-- Modal Entrega Tarea -->
  <div class="modal-backdrop modal-entrega" *ngIf="modalEntregaAbierto">
    <div class="modal-card">
      <div class="modal-header">
        <h3>
          <span class="emoji">{{ formEntrega.esActualizacion ? 'ğŸ”„' : 'ğŸ“¤' }}</span>
          {{ formEntrega.esActualizacion ? 'Actualizar Entrega' : 'Entregar Tarea' }}
        </h3>
        <p class="modal-subtitle">
          {{ formEntrega.esActualizacion ? 'Actualiza tu entrega existente' : 'EnvÃ­a tu tarea para evaluaciÃ³n' }}
        </p>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label class="label-required">Archivo de entrega</label>
          <div class="file-upload-area" [class.has-file]="archivoSeleccionado">
            <div class="upload-icon">ğŸ“¤</div>
            <div class="upload-text" *ngIf="!archivoSeleccionado">
              Arrastra y suelta tu archivo aquÃ­
            </div>
            <div class="upload-text" *ngIf="archivoSeleccionado">
              {{ nombreArchivo }}
            </div>
            <div class="upload-subtext">o haz clic para seleccionar</div>
            <div class="formatos">Formatos: PDF, DOC, JPG, PNG, ZIP, TXT (MÃ¡x. 20MB)</div>
            <input type="file" 
                   (change)="onFileSelected($event)" 
                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.zip,.rar,.txt,.xls,.xlsx,.ppt,.pptx">
          </div>
        </div>
        
        <div class="form-group">
          <label>Comentario para el docente (opcional)</label>
          <textarea [(ngModel)]="formEntrega.comentario_alumno" 
                    rows="3" 
                    placeholder="Escribe algÃºn comentario o aclaraciÃ³n sobre tu entrega..."
                    class="textarea-comentario"></textarea>
        </div>
        
        <div *ngIf="errorModalEntrega" class="error-message">
          <span class="emoji">âš ï¸</span> {{ errorModalEntrega }}
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn-cancelar" (click)="cerrarModalEntrega()">
          <span class="emoji">â†</span> Cancelar
        </button>
        <button class="btn-guardar" (click)="enviarEntrega()" [disabled]="entregandoTarea">
          <span *ngIf="entregandoTarea" class="spinner-button"></span>
          {{ entregandoTarea ? 'Enviando...' : (formEntrega.esActualizacion ? 'Actualizar' : 'Entregar') }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Alerta -->
  <div class="modal-backdrop" *ngIf="modalAlertaAbierto">
    <div class="modal-card">
      <h3>{{ alertaTitulo }}</h3>
      <div [ngClass]="{
        'text-success': alertaTipo === 'success',
        'text-error': alertaTipo === 'error',
        'text-info': alertaTipo === 'info',
        'text-warning': alertaTipo === 'warning'
      }">
        {{ alertaMensaje }}
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" (click)="cerrarAlerta()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal ConfirmaciÃ³n -->
  <div class="modal-backdrop" *ngIf="modalConfirmacionAbierto">
    <div class="modal-card">
      <h3>{{ confirmacionTitulo }}</h3>
      <div [innerHTML]="confirmacionMensaje"></div>
      <div class="modal-actions">
        <button class="btn btn-neutral" (click)="cerrarConfirmacion()">Cancelar</button>
        <button class="btn btn-danger" (click)="aceptarConfirmacion()">Confirmar</button>
      </div>
    </div>
  </div>

</div>