<div class="estudiante-page">
  <!-- HEADER SUPERIOR SIMPLE -->
  <div class="top-header">
    <div class="update-info">
      <span class="update-icon">ğŸ”„</span>
      Actualizado: {{ fechaActual | date:'medium' }}
    </div>
  </div>

  <div class="container">
    
    <!-- HEADER PRINCIPAL -->
    <div class="student-header">
      <div class="header-content">
        <div class="student-profile">
          <div class="gradient-avatar">
            {{ obtenerIniciales(estudiante?.nombre || '') }}
          </div>
          <div class="student-info">
            <h1>Â¡Hola, {{ estudiante?.nombre || 'Estudiante' }}!</h1>
            <p>Gestiona tus tareas acadÃ©micas</p>
            <div class="student-stats">
              <span class="stat">{{ tareas.length }} Tareas</span>
              <span class="stat">{{ misEntregas.length }} Entregas</span>
            </div>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-outline" (click)="recargarTodo()">
            <span class="btn-icon">ğŸ”„</span>
            Actualizar
          </button>
          <button class="btn btn-primary" (click)="probarConexion()">
            <span class="btn-icon">ğŸ”</span>
            Probar ConexiÃ³n
          </button>
        </div>
      </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main-content">
      
      <!-- SECCIÃ“N TAREAS PENDIENTES -->
      <div class="section">
        <div class="section-header">
          <h2>Tareas Pendientes</h2>
          <div class="badge">{{ tareas.length }} tareas</div>
        </div>
        
        <div class="section-body">
          <!-- Estados de carga -->
          <div class="estado-carga" *ngIf="loadingTareas">
            <div class="loading-spinner"></div>
            Cargando tus tareas...
          </div>
          
          <div class="estado-error" *ngIf="errorTareas">
            <div class="error-icon">âŒ</div>
            {{ errorTareas }}
          </div>

          <!-- Grid de tareas -->
          <div class="tareas-grid" *ngIf="!loadingTareas && tareas.length > 0">
            <div *ngFor="let tarea of tareas" 
                 class="tarea-card"
                 [class.vencida]="esTareaVencida(tarea)">
              
              <div class="card-gradient"></div>
              <div class="card-content">
                <div class="tarea-header">
                  <div class="priority-indicator" 
                       [class.high]="tiempoRestante(tarea) === 'Vencida'"></div>
                  <h3 class="tarea-title">{{ tarea.titulo }}</h3>
                  <div class="tarea-status">
                    <span class="deadline-badge" 
                          [class.urgent]="tiempoRestante(tarea) === 'Vencida'">
                      {{ tiempoRestante(tarea) }}
                    </span>
                  </div>
                </div>

                <p class="tarea-description">
                  {{ tarea.instrucciones || 'Sin instrucciones especÃ­ficas' }}
                </p>

                <div class="tarea-meta">
                  <div class="meta-chip">
                    <span class="meta-icon">ğŸ“…</span>
                    {{ tarea.fecha_cierre | date:'short' }}
                  </div>
                  <div class="meta-chip" [class.allowed]="permiteTarde(tarea)">
                    <span class="meta-icon">â°</span>
                    {{ permiteTarde(tarea) ? 'TardÃ­as OK' : 'No tardÃ­as' }}
                  </div>
                </div>

                <div class="tarea-actions">
                  <button class="btn btn-outline" (click)="abrirModalDetalles(tarea)">
                    <span class="btn-icon">ğŸ‘€</span>
                    Detalles
                  </button>
                  <button class="btn btn-primary" 
                          (click)="abrirModalEntrega(tarea)"
                          [disabled]="esTareaVencida(tarea) && !permiteTarde(tarea)">
                    <span class="btn-icon">ğŸ“¤</span>
                    {{ obtenerEstadoEntrega(tarea.id_tarea) ? 'Reentregar' : 'Entregar' }}
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Estado vacÃ­o -->
          <div class="estado-vacio" *ngIf="!loadingTareas && tareas.length === 0">
            <div class="empty-icon">ğŸ‰</div>
            <h3>Â¡No tienes tareas pendientes!</h3>
            <p>Parece que estÃ¡s al dÃ­a con tus asignaciones</p>
          </div>
        </div>
      </div>

      <!-- SECCIÃ“N MIS ENTREGAS -->
      <div class="section" *ngIf="misEntregas.length > 0">
        <div class="section-header">
          <h2>Mis Entregas</h2>
          <div class="badge">{{ misEntregas.length }} entregas</div>
        </div>
        
        <div class="section-body">
          <div class="entregas-list">
            <div *ngFor="let entrega of misEntregas" class="entrega-item">
              <div class="entrega-header">
                <h4>{{ entrega.titulo_tarea || 'Tarea' }}</h4>
                <span [class]="estadoEntregaClass(entrega.estado)" class="status">
                  {{ entrega.estado || 'Entregado' }}
                </span>
              </div>
              
              <div class="entrega-details">
                <span class="fecha">ğŸ“… {{ entrega.fecha_entrega | date:'medium' }}</span>
                <span class="grade" *ngIf="entrega.calificacion !== null">
                  â­ Nota: {{ entrega.calificacion }}/10
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DETALLES TAREA -->
  <div class="modal-backdrop" *ngIf="modalDetallesAbierto">
    <div class="modal">
      <div class="modal-header">
        <h3>ğŸ“– Detalles de la Tarea</h3>
        <button class="close" (click)="cerrarModalDetalles()">Ã—</button>
      </div>
      
      <div class="modal-body" *ngIf="tareaSeleccionada">
        <div class="detalle-tarea">
          
          <!-- InformaciÃ³n Principal -->
          <div class="detalle-seccion">
            <h4>{{ tareaSeleccionada.titulo }}</h4>
            <div class="estado-tiempo">
              <span class="badge" [class.vencida]="esTareaVencida(tareaSeleccionada)">
                {{ esTareaVencida(tareaSeleccionada) ? 'â° Vencida' : 'â³ Activa' }}
              </span>
              <span class="tiempo-restante">
                {{ tiempoRestante(tareaSeleccionada) }}
              </span>
            </div>
          </div>

          <!-- Instrucciones -->
          <div class="detalle-seccion">
            <label>ğŸ“‹ Instrucciones</label>
            <div class="contenido-detalle">
              {{ tareaSeleccionada.instrucciones || 'No hay instrucciones especÃ­ficas' }}
            </div>
          </div>

          <!-- Fechas -->
          <div class="detalle-seccion">
            <label>ğŸ“… Fechas Importantes</label>
            <div class="fechas-grid">
              <div class="fecha-item">
                <strong>PublicaciÃ³n:</strong>
                <span>{{ (tareaSeleccionada.fecha_publicacion | date:'medium') || 'No especificada' }}</span>
              </div>
              <div class="fecha-item">
                <strong>Entrega:</strong>
                <span>{{ tareaSeleccionada.fecha_cierre | date:'medium' }}</span>
              </div>
            </div>
          </div>

          <!-- ConfiguraciÃ³n -->
          <div class="detalle-seccion">
            <label>âš™ï¸ ConfiguraciÃ³n</label>
            <div class="config-grid">
              <div class="config-item">
                <span class="config-icon">â°</span>
                <span>Entrega tardÃ­a: {{ permiteTarde(tareaSeleccionada) ? 'Permitida' : 'No permitida' }}</span>
              </div>
              <div class="config-item">
                <span class="config-icon">ğŸ“Š</span>
                <span>Estado: {{ estaActiva(tareaSeleccionada) ? 'Activa' : 'Inactiva' }}</span>
              </div>
            </div>
          </div>

          <!-- Material Adjunto -->
          <div class="detalle-seccion" *ngIf="tareaSeleccionada.archivo_adjunto">
            <label>ğŸ“ Material de Apoyo</label>
            <div class="archivo-descarga">
              <a [href]="fileUrl(tareaSeleccionada.archivo_adjunto)" 
                 target="_blank" 
                 download
                 class="btn-descarga">
                <span class="file-icon">ğŸ“¥</span>
                Descargar {{ obtenerNombreArchivo(tareaSeleccionada.archivo_adjunto) }}
              </a>
            </div>
          </div>

          <!-- RÃºbrica -->
          <div class="detalle-seccion" *ngIf="tareaSeleccionada.rubrica">
            <label>ğŸ“Š RÃºbrica de EvaluaciÃ³n</label>
            <div class="rubrica-contenido">
              <pre>{{ tareaSeleccionada.rubrica }}</pre>
            </div>
          </div>

        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="cerrarModalDetalles()">
          Cerrar
        </button>
        <button class="btn btn-primary" 
                (click)="abrirModalEntrega(tareaSeleccionada)"
                [disabled]="esTareaVencida(tareaSeleccionada) && !permiteTarde(tareaSeleccionada)">
          <span class="btn-icon">ğŸ“¤</span>
          Entregar Tarea
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL ENTREGA TAREA - DISEÃ‘O MEJORADO -->
  <div class="modal-backdrop" *ngIf="modalEntregaAbierto">
    <div class="modal">
      <div class="modal-header">
        <h3>ğŸ“¤ Entregar Tarea</h3>
        <button class="close" (click)="cerrarModalEntrega()">Ã—</button>
      </div>
      
      <div class="modal-body">
        <!-- InformaciÃ³n de la tarea -->
        <div class="tarea-info" *ngIf="tareaSeleccionada">
          <div class="tarea-header">
            <h4>{{ tareaSeleccionada.titulo }}</h4>
            <div class="tarea-meta">
              <span class="deadline">
                ğŸ“… Vence: {{ tareaSeleccionada.fecha_cierre | date:'medium' }}
              </span>
              <span class="time-left" [class.urgent]="tiempoRestante(tareaSeleccionada) === 'Vencida'">
                ({{ tiempoRestante(tareaSeleccionada) }})
              </span>
            </div>
          </div>
        </div>

        <!-- Alertas -->
        <div class="alert alert-warning" 
             *ngIf="esTareaVencida(tareaSeleccionada) && !permiteTarde(tareaSeleccionada)">
          <div class="alert-icon">âš ï¸</div>
          <div class="alert-content">
            <strong>Esta tarea estÃ¡ vencida</strong>
            <p>No se permiten entregas tardÃ­as para esta tarea</p>
          </div>
        </div>

        <div class="alert alert-info" *ngIf="obtenerEstadoEntrega(tareaSeleccionada?.id_tarea)">
          <div class="alert-icon">â„¹ï¸</div>
          <div class="alert-content">
            <strong>Ya has entregado esta tarea</strong>
            <p>Puedes reemplazar tu entrega anterior</p>
          </div>
        </div>

        <!-- Formulario de entrega -->
        <div class="upload-section">
          <div class="form-group">
            <label class="form-label">ğŸ“ Archivo de Entrega</label>
            <div class="file-upload-area" 
                 [class.dragover]="isDragover"
                 (drop)="onFileDrop($event)"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)">
              <input type="file" id="fileInput" 
                     (change)="onFileSelectedEntrega($event)" 
                     accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.zip,.rar">
              <div class="upload-content">
                <div class="upload-icon">ğŸ“</div>
                <h4>Arrastra tu archivo aquÃ­</h4>
                <p>o haz clic para seleccionar</p>
                <small>Formatos: PDF, Word, imÃ¡genes, ZIP, RAR (max 10MB)</small>
              </div>
            </div>
            
            <!-- Archivo seleccionado -->
            <div class="file-preview" *ngIf="archivoEntrega">
              <div class="file-info">
                <span class="file-icon">{{ obtenerIconoArchivo(archivoEntrega.name) }}</span>
                <div class="file-details">
                  <strong>{{ archivoEntrega.name }}</strong>
                  <span>{{ (archivoEntrega.size / 1024 / 1024).toFixed(2) }} MB</span>
                </div>
                <button class="remove-file" (click)="archivoEntrega = null">Ã—</button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">ğŸ’¬ Comentarios para el Profesor</label>
            <textarea class="textarea" 
                      rows="4" 
                      [(ngModel)]="comentarioAlumno"
                      placeholder="Explica tu entrega, aÃ±ade comentarios o aclaraciones..."></textarea>
            <div class="char-count">{{ comentarioAlumno.length }}/500</div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="cerrarModalEntrega()">
          Cancelar
        </button>
        <button class="btn btn-primary" 
                (click)="enviarEntrega()"
                [disabled]="subiendoEntrega || (esTareaVencida(tareaSeleccionada) && !permiteTarde(tareaSeleccionada)) || (!archivoEntrega && !comentarioAlumno.trim())">
          <span class="btn-icon" *ngIf="!subiendoEntrega">ğŸš€</span>
          <span class="btn-icon" *ngIf="subiendoEntrega">â³</span>
          {{ subiendoEntrega ? 'Enviando...' : 'Enviar Entrega' }}
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL ALERTA -->
  <div class="modal-backdrop" *ngIf="modalAlertaAbierto">
    <div class="modal alert-modal">
      <div class="modal-header">
        <h3>{{ alertaTitulo }}</h3>
        <button class="close" (click)="cerrarAlerta()">Ã—</button>
      </div>
      
      <div class="modal-body text-center">
        <div class="alert-emoji">
          {{ alertaTitulo.includes('âœ…') ? 'ğŸ‰' : alertaTitulo.includes('âŒ') ? 'ğŸ˜•' : 'ğŸ“¢' }}
        </div>
        <div class="alert-message" [innerHTML]="alertaMensaje"></div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-primary" (click)="cerrarAlerta()" style="flex: 1;">
          <span class="btn-icon">ğŸ‘Œ</span>
          Entendido
        </button>
      </div>
    </div>
  </div>
</div>