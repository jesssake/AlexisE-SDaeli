import{$ as b,$a as O,B as f,Ba as F,C as P,Cc as et,L as N,La as z,Oa as C,Sb as W,Tb as J,Ub as U,V as j,Va as p,Wa as d,Xa as s,Za as A,_ as x,_a as V,_b as Q,a as w,ab as _,b as y,bb as l,db as R,dc as S,eb as $,ec as M,fa as m,fb as B,fc as q,ha as D,ib as E,ic as G,kb as c,kc as K,lb as v,lc as Z,mb as I,o as h,oc as tt,pb as L,qb as Y,rb as X,t as g,vb as H,wa as r,z as k}from"./chunk-SB32BB4B.js";var it=["scroller"],ot=(o,e,t,n)=>({"left.px":o,"top.px":e,"width.px":t,"height.px":n});function at(o,e){if(o&1&&(d(0,"small"),c(1),s()),o&2){let t=l();r(),I("Alumno #",t.alumnoId)}}function rt(o,e){if(o&1&&(d(0,"small"),c(1),s()),o&2){let t=l();r(),I("\xB7 Tutor #",t.tutorId)}}function st(o,e){o&1&&(d(0,"div",14),c(1,"Cargando\u2026"),s())}function dt(o,e){if(o&1&&(d(0,"div",15),c(1),s()),o&2){let t=l(2);r(),v(t.errorMsg)}}function lt(o,e){if(o&1){let t=O();d(0,"div",25)(1,"button",26),_("click",function(){x(t);let i=l().$implicit,a=l(3);return b(a.beginEdit(i))}),c(2,"\u270E"),s(),d(3,"button",27),_("click",function(){x(t);let i=l().$implicit,a=l(3);return b(a.deleteForAll(i))}),c(4,"\u{1F5D1}"),s()()}}function ct(o,e){if(o&1&&(d(0,"div",28),c(1),s()),o&2){let t=l().$implicit;r(),v(t.texto)}}function pt(o,e){if(o&1){let t=O();d(0,"div",29)(1,"textarea",30),X("ngModelChange",function(i){x(t);let a=l(4);return Y(a.editBuffer,i)||(a.editBuffer=i),b(i)}),s(),d(2,"div",31)(3,"button",32),_("click",function(){x(t);let i=l().$implicit,a=l(3);return b(a.saveEdit(i))}),c(4,"Guardar"),s(),d(5,"button",33),_("click",function(){x(t);let i=l(4);return b(i.cancelEdit())}),c(6,"Cancelar"),s()()()}if(o&2){let t=l(4);r(),L("ngModel",t.editBuffer)}}function ut(o,e){if(o&1&&(d(0,"div",17)(1,"div",18)(2,"div",19)(3,"span",20),c(4),s(),d(5,"span",21),c(6),s(),C(7,lt,5,0,"div",22),s(),C(8,ct,2,1,"div",23)(9,pt,7,1,"div",24),s()()),o&2){let t=e.$implicit,n=l(3);E("mine",t.emisor==="MAESTRO"),r(),E("is-editing",n.editingId()===t.id),r(3),v(t.emisor),r(2),v(n.fmtFecha(t.creado_en)),r(),p("ngIf",t.emisor==="MAESTRO"&&n.editingId()!==t.id),r(),p("ngIf",n.editingId()!==t.id),r(),p("ngIf",n.editingId()===t.id)}}function mt(o,e){o&1&&(d(0,"div",14),c(1,"No hay mensajes a\xFAn."),s())}function ht(o,e){if(o&1&&(A(0),C(1,ut,10,9,"div",16)(2,mt,2,0,"div",12),V()),o&2){let t=l(2);r(),p("ngForOf",t.mensajes())("ngForTrackBy",t.trackMsg),r(),p("ngIf",t.mensajes().length===0)}}function gt(o,e){if(o&1&&(d(0,"section",11,0),C(2,st,2,0,"div",12)(3,dt,2,1,"div",13)(4,ht,3,3,"ng-container",4),s()),o&2){let t=l();r(2),p("ngIf",t.cargando),r(),p("ngIf",t.errorMsg),r(),p("ngIf",!t.cargando&&!t.errorMsg)}}function _t(o,e){if(o&1){let t=O();d(0,"footer",34)(1,"textarea",35),_("ngModelChange",function(i){x(t);let a=l();return b(a.nuevo.set(i))}),s(),d(2,"button",36),_("click",function(){x(t);let i=l();return b(i.enviar())}),c(3),s()()}if(o&2){let t=l();r(),p("ngModel",t.nuevo()),r(),p("disabled",t.enviando||!t.nuevo().trim()),r(),I(" ",t.enviando?"Enviando\u2026":"Enviar"," ")}}var nt=class o{alumnoId;tutorId=null;titulo="Chat";floating=!0;role="MAESTRO";closed=new F;cargando=!0;enviando=!1;errorMsg=null;minimized=m(!1);compact=m(!1);mensajes=m([]);nuevo=m("");editingId=m(null);editBuffer="";http=j(q);base="/api/chat";sub;chatId=m(null);legacyMode=m("none");get maestroId(){let e=Number(localStorage.getItem("maestro_id"));return Number.isFinite(e)&&e>0?e:1}posX=m(window.innerWidth-420-24);posY=m(96);width=m(380);height=m(520);dragging=!1;dragOffX=0;dragOffY=0;scroller;ngOnInit(){this.reopen()}ngOnChanges(e){(e.alumnoId||e.tutorId)&&this.reopen()}ngOnDestroy(){this.sub?.unsubscribe()}reopen(){this.sub?.unsubscribe(),this.cargando=!0,this.errorMsg=null,this.enviando=!1,this.mensajes.set([]),this.editingId.set(null),this.editBuffer="",this.chatId.set(null),this.legacyMode.set("none"),this.resolveChat().subscribe({next:e=>{this.cargando=!1,e?this.chatId.set(e):this.tutorId!=null?this.legacyMode.set("maestro+tutor"):this.alumnoId>0?this.legacyMode.set("maestro+alumno"):this.errorMsg="No se pudo iniciar el chat.",this.startPolling()},error:e=>{this.cargando=!1,this.errorMsg="No se pudo iniciar el chat."}})}getText(e,t){return this.http.get(e,{params:t,responseType:"text"})}postFormText(e,t){let n=new URLSearchParams;Object.entries(t).forEach(([a,u])=>u!=null&&n.set(a,String(u)));let i=new S({"Content-Type":"application/x-www-form-urlencoded"});return this.http.post(e,n.toString(),{headers:i,responseType:"text"})}postJsonText(e,t){let n=new S({"Content-Type":"application/json"});return this.http.post(e,t,{headers:n,responseType:"text"})}safeParse(e){let t=(e??"").toString().trim();if(!t||t==="null")return null;if(t==="[]")return[];let n=Number(t);if(!Number.isNaN(n)&&t===String(n))return n;try{return JSON.parse(t)}catch{return null}}pickChatId(e){if(e==null)return null;if(typeof e=="number")return e||null;let t=e.chat_id??e.id??(Array.isArray(e)&&e[0]?.chat_id);return t!=null?Number(t):null}resolveChat(){let e=this.alumnoId>0,t=this.tutorId!=null,n=new M().set("maestro_id",String(this.maestroId));return e&&(n=n.set("alumno_id",String(this.alumnoId)).set("nino_id",String(this.alumnoId))),t&&(n=n.set("tutor_id",String(this.tutorId))),this.getText(`${this.base}/participants.php`,n).pipe(g(i=>this.pickChatId(this.safeParse(i))),P(i=>{if(i)return h(i);let a={maestro_id:this.maestroId,alumno_id:e?this.alumnoId:void 0,nino_id:e?this.alumnoId:void 0,tutor_id:t?this.tutorId:void 0};return this.postFormText(`${this.base}/participants.php`,a).pipe(g(u=>this.pickChatId(this.safeParse(u))),f(()=>h(null)))}),P(i=>{if(i)return h(i);let a=new M().set("maestro_id",String(this.maestroId));return e&&(a=a.set("alumno_id",String(this.alumnoId)).set("nino_id",String(this.alumnoId))),t&&(a=a.set("tutor_id",String(this.tutorId))),this.getText(`${this.base}/list.php`,a).pipe(g(u=>this.pickChatId(this.safeParse(u))),f(()=>h(null)))}),P(i=>{if(i)return h(i);if(!e&&!t)return h(null);let a={maestro_id:this.maestroId,alumno_id:e?this.alumnoId:void 0,nino_id:e?this.alumnoId:void 0,tutor_id:t?this.tutorId:void 0,tipo:"direct",direct:1};return this.postFormText(`${this.base}/create_direct.php`,a).pipe(g(u=>this.pickChatId(this.safeParse(u))),f(()=>this.postJsonText(`${this.base}/create_direct.php`,a).pipe(g(u=>this.pickChatId(this.safeParse(u))),f(()=>h(null)))))}))}startPolling(){this.sub?.unsubscribe(),this.sub=k(0,4e3).pipe(N(()=>{let e=this.chatId(),t=this.legacyMode();if(e){let n=new M().set("chat_id",String(e));return this.getText(`${this.base}/messages.php`,n).pipe(g(i=>this.safeParse(i)??[]))}if(t==="maestro+tutor"&&this.tutorId!=null){let n=new M().set("maestro_id",String(this.maestroId)).set("tutor_id",String(this.tutorId));return this.getText(`${this.base}/messages.php`,n).pipe(g(i=>this.safeParse(i)??[]))}if(t==="maestro+alumno"&&this.alumnoId>0){let n=new M().set("maestro_id",String(this.maestroId)).set("alumno_id",String(this.alumnoId)).set("nino_id",String(this.alumnoId));return this.getText(`${this.base}/messages.php`,n).pipe(g(i=>this.safeParse(i)??[]))}return h([])}),f(e=>h([]))).subscribe(e=>{let t=(e??[]).map(n=>({id:Number(n.id??n.msg_id??n.message_id??0),alumno_id:Number(n.alumno_id??n.nino_id??this.alumnoId??0),tutor_id:n.tutor_id!=null?Number(n.tutor_id):this.tutorId,emisor:n.emisor??n.from??"SISTEMA",texto:String(n.texto??n.message??n.mensaje??""),creado_en:String(n.creado_en??n.created_at??new Date().toISOString())}));this.mensajes.set(t.sort((n,i)=>n.id-i.id)),queueMicrotask(()=>this.scrollBottom())})}enviar(){let e=this.nuevo().trim();if(!e)return;this.enviando=!0;let t=this.chatId(),n=this.legacyMode(),i={maestro_id:this.maestroId,texto:e,mensaje:e,emisor:this.role,from:this.role},a={};if(t)a=y(w({},i),{chat_id:t,alumno_id:this.alumnoId||void 0,nino_id:this.alumnoId||void 0,tutor_id:this.tutorId??void 0});else if(n==="maestro+tutor"&&this.tutorId!=null)a=y(w({},i),{tutor_id:this.tutorId});else if(n==="maestro+alumno"&&this.alumnoId>0)a=y(w({},i),{alumno_id:this.alumnoId,nino_id:this.alumnoId});else{this.enviando=!1;return}this.postFormText(`${this.base}/send.php`,a).pipe(g(()=>!0),f(()=>this.postJsonText(`${this.base}/send.php`,a).pipe(g(()=>!0),f(()=>h(!1))))).subscribe(u=>{u&&(this.nuevo.set(""),this.startPolling()),this.enviando=!1})}beginEdit(e){this.editingId.set(e.id),this.editBuffer=e.texto}cancelEdit(){this.editingId.set(null),this.editBuffer=""}saveEdit(e){let t=this.editBuffer.trim();if(!t)return;let n=this.chatId();if(!n){this.cancelEdit();return}let i={chat_id:n,mensaje_id:e.id,texto:t,emisor:this.role};this.postFormText(`${this.base}/edit.php`,i).pipe(f(()=>this.postJsonText(`${this.base}/edit.php`,i))).subscribe(a=>{this.cancelEdit();let u=this.mensajes().map(T=>T.id===e.id?y(w({},T),{texto:t}):T);this.mensajes.set(u)})}deleteForAll(e){if(!confirm("\xBFEliminar mensaje para todos?"))return;let t=this.chatId();if(!t)return;let n={chat_id:t,mensaje_id:e.id,emisor:this.role};this.postFormText(`${this.base}/delete_for_all.php`,n).pipe(f(()=>this.postJsonText(`${this.base}/delete_for_all.php`,n))).subscribe(i=>{this.mensajes.set(this.mensajes().filter(a=>a.id!==e.id))})}dragStart(e){if(!this.floating)return;this.dragging=!0;let t="touches"in e?e.touches[0]:e;this.dragOffX=t.clientX-this.posX(),this.dragOffY=t.clientY-this.posY(),window.addEventListener("mousemove",this.dragMove),window.addEventListener("touchmove",this.dragMove,{passive:!1}),window.addEventListener("mouseup",this.dragEnd),window.addEventListener("touchend",this.dragEnd)}dragMove=e=>{if(!this.dragging)return;let t="touches"in e?e.touches[0]:e;"touches"in e&&e.preventDefault();let n=Math.min(Math.max(8,t.clientX-this.dragOffX),window.innerWidth-this.width()-8),i=Math.min(Math.max(56,t.clientY-this.dragOffY),window.innerHeight-80);this.posX.set(n),this.posY.set(i)};dragEnd=()=>{this.dragging=!1,window.removeEventListener("mousemove",this.dragMove),window.removeEventListener("touchmove",this.dragMove),window.removeEventListener("mouseup",this.dragEnd),window.removeEventListener("touchend",this.dragEnd)};toggleMin(){this.minimized.set(!this.minimized())}toggleCompact(){this.compact.set(!this.compact()),this.width.set(this.compact()?340:380),this.height.set(this.compact()?460:520)}closeWindow(){this.closed.emit()}scrollBottom(){if(!this.scroller)return;let e=this.scroller.nativeElement;e.scrollTop=e.scrollHeight}fmtFecha=e=>new Date(e).toLocaleString();trackMsg=(e,t)=>t.id;static \u0275fac=function(t){return new(t||o)};static \u0275cmp=z({type:o,selectors:[["app-chat-panel"]],viewQuery:function(t,n){if(t&1&&R(it,5),t&2){let i;$(i=B())&&(n.scroller=i.first)}},inputs:{alumnoId:"alumnoId",tutorId:"tutorId",titulo:"titulo",floating:"floating",role:"role"},outputs:{closed:"closed"},features:[D],decls:16,vars:14,consts:[["scroller",""],[1,"chat-wrap",3,"ngStyle"],[1,"chat-head",3,"mousedown","touchstart"],[1,"title"],[4,"ngIf"],[1,"window-actions"],["type","button","aria-label","Compactar/expandir",1,"icon",3,"click"],["type","button","aria-label","Minimizar/Restaurar",1,"icon",3,"click"],["type","button","aria-label","Cerrar",1,"icon","danger",3,"click"],["class","chat-body",4,"ngIf"],["class","chat-foot",4,"ngIf"],[1,"chat-body"],["class","state",4,"ngIf"],["class","state error",4,"ngIf"],[1,"state"],[1,"state","error"],["class","msg",3,"mine",4,"ngFor","ngForOf","ngForTrackBy"],[1,"msg"],[1,"bubble"],[1,"meta"],[1,"who"],[1,"when"],["class","msg-actions",4,"ngIf"],["class","text",4,"ngIf"],["class","edit-box",4,"ngIf"],[1,"msg-actions"],["type","button","title","Editar",1,"mini",3,"click"],["type","button","title","Eliminar para todos",1,"mini","danger",3,"click"],[1,"text"],[1,"edit-box"],["rows","2",3,"ngModelChange","ngModel"],[1,"edit-actions"],["type","button",1,"mini",3,"click"],["type","button",1,"mini","ghost",3,"click"],[1,"chat-foot"],["rows","2","placeholder","Escribe un mensaje\u2026",3,"ngModelChange","ngModel"],["type","button",1,"send",3,"click","disabled"]],template:function(t,n){t&1&&(d(0,"div",1)(1,"header",2),_("mousedown",function(a){return n.dragStart(a)})("touchstart",function(a){return n.dragStart(a)}),d(2,"div",3)(3,"strong"),c(4),s(),C(5,at,2,1,"small",4)(6,rt,2,1,"small",4),s(),d(7,"div",5)(8,"button",6),_("click",function(){return n.toggleCompact()}),c(9,"\u25AD"),s(),d(10,"button",7),_("click",function(){return n.toggleMin()}),c(11),s(),d(12,"button",8),_("click",function(){return n.closeWindow()}),c(13,"\u2715"),s()()(),C(14,gt,5,3,"section",9)(15,_t,4,3,"footer",10),s()),t&2&&(E("floating",n.floating),p("ngStyle",n.floating?H(9,ot,n.posX(),n.posY(),n.width(),n.height()):null),r(4),v(n.titulo),r(),p("ngIf",n.alumnoId),r(),p("ngIf",n.tutorId),r(5),I(" ",n.minimized()?"\u25A3":"\u2581"," "),r(3),p("ngIf",!n.minimized()),r(),p("ngIf",!n.minimized()))},dependencies:[Q,W,J,U,et,K,Z,tt,G],styles:['@charset "UTF-8";[_nghost-%COMP%]{display:block;font-size:13px}.chat-wrap[_ngcontent-%COMP%]{display:grid;grid-template-rows:auto 1fr auto;height:100%;background:#ffffffeb;-webkit-backdrop-filter:saturate(120%) blur(10px);backdrop-filter:saturate(120%) blur(10px);border:1px solid rgba(0,0,0,.06);border-radius:16px;box-shadow:0 14px 44px #16123829;overflow:hidden}.chat-wrap.floating[_ngcontent-%COMP%]{position:fixed;z-index:1000;-webkit-user-select:none;user-select:none}.chat-head[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;background:linear-gradient(180deg,#f0ecff,#fff 85%);border-bottom:1px solid rgba(0,0,0,.06);cursor:move}.chat-head[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]{display:flex;align-items:baseline;flex-wrap:wrap;gap:8px 10px}.chat-head[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-size:15px;font-weight:800;color:#242338;letter-spacing:.2px}.chat-head[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{font-size:11px;color:#6d7280;margin-top:2px}.window-actions[_ngcontent-%COMP%]{display:flex;gap:8px}.icon[_ngcontent-%COMP%]{width:28px;height:28px;display:inline-grid;place-items:center;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:#fff;font-weight:800;line-height:1;cursor:pointer;transition:transform .06s ease,box-shadow .2s ease,background-color .2s ease}.icon[_ngcontent-%COMP%]:hover{box-shadow:0 6px 18px #0000001a}.icon[_ngcontent-%COMP%]:active{transform:translateY(1px)}.icon.danger[_ngcontent-%COMP%]{color:#b42318}.chat-body[_ngcontent-%COMP%]{position:relative;overflow:auto;padding:12px 12px 8px;background:radial-gradient(900px 420px at 130% -10%,#f3f6ff 0%,transparent 60%),radial-gradient(700px 380px at -20% -10%,#fff5fb 0%,transparent 60%),#f7f8fb}.chat-body[_ngcontent-%COMP%] > h1[_ngcontent-%COMP%], .chat-body[_ngcontent-%COMP%] > h2[_ngcontent-%COMP%]{display:none}.state[_ngcontent-%COMP%]{margin:10px 4px;font-size:12.5px;color:#6b7280}.state.error[_ngcontent-%COMP%]{color:#b42318}.msg[_ngcontent-%COMP%]{display:flex;margin:10px 0}.msg.mine[_ngcontent-%COMP%]{justify-content:flex-end}.bubble[_ngcontent-%COMP%]{position:relative;max-width:72%;padding:9px 12px;border-radius:14px;background:linear-gradient(180deg,#fff,#fafbff);box-shadow:0 8px 22px #0000000f}.msg.mine[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{background:linear-gradient(180deg,#eaf1ff,#e6eeff)}.meta[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-size:10.5px;color:#6b7280;margin-bottom:6px}.meta[_ngcontent-%COMP%]   .who[_ngcontent-%COMP%]{font-weight:800;letter-spacing:.2px;color:#3b3f53}.meta[_ngcontent-%COMP%]   .when[_ngcontent-%COMP%]{opacity:.85}.msg-actions[_ngcontent-%COMP%]{margin-left:auto;display:flex;gap:6px;opacity:0;pointer-events:none;transition:opacity .15s ease}.bubble[_ngcontent-%COMP%]:hover   .msg-actions[_ngcontent-%COMP%]{opacity:1;pointer-events:auto}.mini[_ngcontent-%COMP%]{height:22px;padding:0 8px;border-radius:8px;border:1px solid rgba(0,0,0,.08);background:#fff;font-size:12px;font-weight:700;cursor:pointer}.mini.danger[_ngcontent-%COMP%]{color:#b42318}.mini.ghost[_ngcontent-%COMP%]{background:transparent}.text[_ngcontent-%COMP%]{font-size:13.5px;line-height:1.35;color:#222;white-space:pre-wrap}.edit-box[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{width:100%;resize:vertical;min-height:48px;border:1px solid rgba(0,0,0,.12);border-radius:10px;padding:8px 10px;outline:none;background:#fff}.edit-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:8px;margin-top:6px}.chat-foot[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr auto;gap:10px;padding:10px;border-top:1px solid rgba(0,0,0,.06);background:#fff}.chat-foot[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{resize:vertical;min-height:40px;max-height:140px;width:100%;font-size:13.5px;padding:10px 12px;border:1px solid rgba(0,0,0,.12);border-radius:12px;outline:none;background:#fff;box-shadow:inset 0 1px #fff9}.send[_ngcontent-%COMP%]{height:40px;min-width:104px;border:none;border-radius:12px;font-weight:800;cursor:pointer;color:#fff;background:linear-gradient(180deg,#67f,#56f);box-shadow:0 10px 20px #5566ff40;transition:transform .06s ease,opacity .2s ease,box-shadow .2s ease}.send[_ngcontent-%COMP%]:hover{box-shadow:0 12px 26px #5566ff4d}.send[_ngcontent-%COMP%]:active{transform:translateY(1px)}.send[_ngcontent-%COMP%]:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}.chat-body[_ngcontent-%COMP%]::-webkit-scrollbar{width:8px}.chat-body[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#0000001f;border-radius:8px}']})};export{nt as a};
